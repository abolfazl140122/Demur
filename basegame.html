<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Demur: جهان روانی تعاملی</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
    <script src="https://threejs.org/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://threejs.org/examples/js/libs/stats.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Vazirmatn', sans-serif;
            background: #000;
            color: #fff;
        }
        
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css');
        }
        
        /* صفحه لودینگ سه‌بعدی */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1.5s ease;
        }
        
        .dimensional-loader {
            position: relative;
            width: 300px;
            height: 300px;
            perspective: 1000px;
        }
        
        .cube-3d {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            animation: rotate3d 8s infinite linear;
        }
        
        .face {
            position: absolute;
            width: 200px;
            height: 200px;
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid rgba(46, 204, 113, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            color: #2ecc71;
            text-shadow: 0 0 20px rgba(46, 204, 113, 0.8);
        }
        
        .face.front  { transform: rotateY(0deg) translateZ(100px); }
        .face.back   { transform: rotateY(180deg) translateZ(100px); }
        .face.right  { transform: rotateY(90deg) translateZ(100px); }
        .face.left   { transform: rotateY(-90deg) translateZ(100px); }
        .face.top    { transform: rotateX(90deg) translateZ(100px); }
        .face.bottom { transform: rotateX(-90deg) translateZ(100px); }
        
        .loading-text-3d {
            font-size: 4rem;
            background: linear-gradient(45deg, #2ecc71, #1abc9c, #3498db);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 40px 0;
            text-shadow: 0 0 30px rgba(46, 204, 113, 0.5);
            animation: colorShift 3s infinite alternate;
        }
        
        .control-hints {
            position: absolute;
            bottom: 50px;
            display: flex;
            gap: 30px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        
        .control-item {
            text-align: center;
        }
        
        /* کانتینر اصلی بازی */
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        
        /* کانواس سه‌بعدی */
        #scene-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* رابط کاربری رویال */
        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        /* نوار وضعیت سه‌بعدی */
        .status-hud {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            border: 2px solid rgba(46, 204, 113, 0.4);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transform: perspective(500px) rotateY(-10deg);
            pointer-events: all;
        }
        
        .hud-title {
            color: #2ecc71;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .consciousness-meter {
            width: 300px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .consciousness-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
            transition: width 0.5s ease;
        }
        
        .hud-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(30, 30, 30, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(46, 204, 113, 0.2);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2ecc71;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        /* پنل کنترل */
        .control-panel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            border: 2px solid rgba(46, 204, 113, 0.3);
            display: flex;
            gap: 15px;
            pointer-events: all;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid rgba(46, 204, 113, 0.4);
            color: #2ecc71;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .control-btn:hover {
            background: rgba(46, 204, 113, 0.2);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(46, 204, 113, 0.3);
        }
        
        .control-btn::after {
            content: attr(data-key);
            position: absolute;
            bottom: -25px;
            font-size: 0.8rem;
            color: #aaa;
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .control-btn:hover::after {
            opacity: 1;
        }
        
        /* رابط ارتباط اشیاء */
        .connection-ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }
        
        .connection-line {
            position: absolute;
            height: 3px;
            background: linear-gradient(90deg, #2ecc71, transparent);
            transform-origin: 0 0;
            pointer-events: none;
            z-index: 49;
        }
        
        /* پنل اشیاء متصل */
        .connection-panel {
            position: absolute;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(46, 204, 113, 0.5);
            max-width: 400px;
            pointer-events: all;
            display: none;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.7);
        }
        
        .connection-title {
            color: #2ecc71;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .connection-message {
            background: rgba(30, 30, 30, 0.7);
            border-radius: 10px;
            padding: 20px;
            min-height: 150px;
            margin-bottom: 20px;
            border: 1px solid rgba(46, 204, 113, 0.2);
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .message-word {
            display: inline-block;
            background: rgba(46, 204, 113, 0.2);
            padding: 5px 10px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid rgba(46, 204, 113, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .message-word:hover {
            background: rgba(46, 204, 113, 0.3);
            transform: translateY(-2px);
        }
        
        /* نوار دستورات */
        .command-bar {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(46, 204, 113, 0.4);
            display: none;
            pointer-events: all;
        }
        
        .command-input {
            width: 100%;
            background: transparent;
            border: none;
            color: #2ecc71;
            font-size: 1.2rem;
            font-family: 'Vazirmatn';
            outline: none;
        }
        
        .command-input::placeholder {
            color: rgba(46, 204, 113, 0.5);
        }
        
        /* پنل اشیاء پیدا شده */
        .inventory-panel {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            border: 2px solid rgba(46, 204, 113, 0.3);
            max-width: 400px;
            pointer-events: all;
            transform: perspective(500px) rotateY(10deg);
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .inventory-item {
            width: 60px;
            height: 60px;
            background: rgba(30, 30, 30, 0.7);
            border-radius: 10px;
            border: 2px solid rgba(46, 204, 113, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #2ecc71;
            cursor: grab;
            transition: all 0.3s ease;
        }
        
        .inventory-item:hover {
            transform: scale(1.1);
            border-color: #2ecc71;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.3);
        }
        
        /* کنترل‌های حرکت */
        .movement-controls {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            pointer-events: all;
        }
        
        .move-btn {
            width: 50px;
            height: 50px;
            background: rgba(30, 30, 30, 0.8);
            border: 2px solid rgba(46, 204, 113, 0.4);
            border-radius: 10px;
            color: #2ecc71;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .move-btn:hover {
            background: rgba(46, 204, 113, 0.2);
            transform: translateY(-3px);
        }
        
        .move-center {
            grid-column: 2;
            grid-row: 2;
        }
        
        /* نویگیشن سه‌بعدی */
        .world-nav {
            position: absolute;
            top: 50%;
            left: 30px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: all;
        }
        
        .nav-portal {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .nav-portal::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent, currentColor);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .nav-portal:hover::before {
            opacity: 0.3;
        }
        
        .nav-portal:hover {
            transform: scale(1.2) translateX(10px);
            box-shadow: 0 0 40px currentColor;
        }
        
        .portal-mountains { border-color: #e67e22; color: #e67e22; }
        .portal-ocean { border-color: #3498db; color: #3498db; }
        .portal-void { border-color: #9b59b6; color: #9b59b6; }
        .portal-temple { border-color: #2ecc71; color: #2ecc71; }
        
        /* موزیک پلیر */
        .music-player-3d {
            position: absolute;
            bottom: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 15px 25px;
            border: 2px solid rgba(46, 204, 113, 0.4);
            display: flex;
            align-items: center;
            gap: 15px;
            pointer-events: all;
            transform: perspective(500px) rotateY(5deg);
        }
        
        /* اعلان‌های سه‌بعدی */
        .notification-3d {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) perspective(1000px) rotateX(0deg);
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(30px);
            padding: 30px 50px;
            border-radius: 20px;
            border: 3px solid #2ecc71;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), inset 0 0 100px rgba(46, 204, 113, 0.1);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .notification-3d.active {
            opacity: 1;
            transform: translate(-50%, -50%) perspective(1000px) rotateX(0deg) scale(1);
            pointer-events: all;
        }
        
        /* انیمیشن‌ها */
        @keyframes rotate3d {
            0% { transform: rotateX(0) rotateY(0) rotateZ(0); }
            100% { transform: rotateX(360deg) rotateY(360deg) rotateZ(180deg); }
        }
        
        @keyframes colorShift {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        @keyframes float3d {
            0%, 100% { transform: translateY(0) rotate(0); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        @keyframes pulse3d {
            0% { box-shadow: 0 0 20px currentColor; }
            100% { box-shadow: 0 0 50px currentColor, 0 0 100px currentColor; }
        }
        
        /* حالت VR/سه‌بعدی */
        .vr-toggle {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(46, 204, 113, 0.5);
            color: #2ecc71;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            pointer-events: all;
            z-index: 101;
            transition: all 0.3s ease;
        }
        
        .vr-toggle:hover {
            background: rgba(46, 204, 113, 0.2);
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.4);
        }
        
        /* اسکرول‌بار سفارشی */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(20, 20, 20, 0.5);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #2ecc71, #1abc9c);
            border-radius: 5px;
        }
        
        /* ریسپانسیو */
        @media (max-width: 1200px) {
            .status-hud { right: 15px; top: 15px; padding: 15px; }
            .control-panel { gap: 10px; padding: 15px; }
            .control-btn { width: 50px; height: 50px; }
            .inventory-panel { left: 15px; top: 15px; padding: 15px; }
        }
        
        @media (max-width: 768px) {
            .status-hud { width: calc(100% - 30px); }
            .consciousness-meter { width: 100%; }
            .control-panel { width: calc(100% - 30px); justify-content: space-around; }
            .movement-controls { display: none; }
            .world-nav { flex-direction: row; top: auto; bottom: 150px; left: 50%; transform: translateX(-50%); }
        }
    </style>
</head>
<body>
    <!-- صفحه لودینگ سه‌بعدی -->
    <div id="loading-screen">
        <div class="dimensional-loader">
            <div class="cube-3d">
                <div class="face front"><i class="fas fa-brain"></i></div>
                <div class="face back"><i class="fas fa-eye"></i></div>
                <div class="face right"><i class="fas fa-heart"></i></div>
                <div class="face left"><i class="fas fa-skull"></i></div>
                <div class="face top"><i class="fas fa-mask"></i></div>
                <div class="face bottom"><i class="fas fa-infinity"></i></div>
            </div>
        </div>
        
        <h1 class="loading-text-3d">DEMUR: جهان روانی</h1>
        <p style="color: #aaa; margin-bottom: 40px; text-align: center; max-width: 600px;">
            یک فضای سه‌بعدی تعاملی برای کاوش در ناخودآگاه<br>
            از تمام کلیدهای کیبورد و موس استفاده کنید
        </p>
        
        <div class="control-hints">
            <div class="control-item">
                <div style="background: rgba(46, 204, 113, 0.2); padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                    <i class="fas fa-keyboard" style="font-size: 2rem;"></i>
                </div>
                <div>WASD - حرکت</div>
            </div>
            <div class="control-item">
                <div style="background: rgba(46, 204, 113, 0.2); padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                    <i class="fas fa-mouse" style="font-size: 2rem;"></i>
                </div>
                <div>موس - نگاه کردن</div>
            </div>
            <div class="control-item">
                <div style="background: rgba(46, 204, 113, 0.2); padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                    <i class="fas fa-hand-pointer" style="font-size: 2rem;"></i>
                </div>
                <div>کلیک - گرفتن اشیاء</div>
            </div>
            <div class="control-item">
                <div style="background: rgba(46, 204, 113, 0.2); padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                    <i class="fas fa-project-diagram" style="font-size: 2rem;"></i>
                </div>
                <div>اتصال اشیاء</div>
            </div>
        </div>
    </div>
    
    <!-- کانتینر اصلی -->
    <div id="game-container">
        <!-- کانواس سه‌بعدی -->
        <div id="scene-container"></div>
        
        <!-- رابط کاربری -->
        <div class="game-ui">
            <!-- نوار وضعیت -->
            <div class="status-hud">
                <div class="hud-title">
                    <i class="fas fa-compass"></i>
                    وضعیت آگاهی
                </div>
                <div class="consciousness-meter">
                    <div class="consciousness-fill" id="consciousnessFill"></div>
                </div>
                <div class="hud-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="connectionCount">0</div>
                        <div class="stat-label">اتصالات</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="objectCount">0</div>
                        <div class="stat-label">اشیاء کشف شده</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="insightLevel">1</div>
                        <div class="stat-label">سطح بینش</div>
                    </div>
                </div>
            </div>
            
            <!-- پنل اشیاء -->
            <div class="inventory-panel">
                <div class="hud-title">
                    <i class="fas fa-box-open"></i>
                    اشیاء کشف شده
                </div>
                <div class="inventory-grid" id="inventoryGrid">
                    <!-- اشیاء اینجا اضافه می‌شوند -->
                </div>
            </div>
            
            <!-- پنل کنترل -->
            <div class="control-panel">
                <button class="control-btn" data-key="Space" id="actionBtn">
                    <i class="fas fa-bolt"></i>
                </button>
                <button class="control-btn" data-key="E" id="interactBtn">
                    <i class="fas fa-hand-rock"></i>
                </button>
                <button class="control-btn" data-key="Q" id="abilityBtn">
                    <i class="fas fa-magic"></i>
                </button>
                <button class="control-btn" data-key="Tab" id="inventoryBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="control-btn" data-key="C" id="crouchBtn">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button class="control-btn" data-key="Shift" id="runBtn">
                    <i class="fas fa-running"></i>
                </button>
                <button class="control-btn" data-key="F" id="flashlightBtn">
                    <i class="fas fa-lightbulb"></i>
                </button>
                <button class="control-btn" data-key="M" id="mapBtn">
                    <i class="fas fa-map"></i>
                </button>
            </div>
            
            <!-- کنترل‌های حرکت -->
            <div class="movement-controls">
                <div class="move-btn" data-action="forward"><i class="fas fa-arrow-up"></i></div>
                <div class="move-btn" data-action="left"><i class="fas fa-arrow-left"></i></div>
                <div class="move-btn move-center" data-action="jump"><i class="fas fa-arrow-circle-up"></i></div>
                <div class="move-btn" data-action="right"><i class="fas fa-arrow-right"></i></div>
                <div class="move-btn" data-action="backward"><i class="fas fa-arrow-down"></i></div>
            </div>
            
            <!-- نویگیشن جهان‌ها -->
            <div class="world-nav">
                <div class="nav-portal portal-mountains" data-world="mountains">
                    <i class="fas fa-mountain"></i>
                </div>
                <div class="nav-portal portal-ocean" data-world="ocean">
                    <i class="fas fa-water"></i>
                </div>
                <div class="nav-portal portal-void" data-world="void">
                    <i class="fas fa-infinity"></i>
                </div>
                <div class="nav-portal portal-temple" data-world="temple">
                    <i class="fas fa-torii-gate"></i>
                </div>
            </div>
            
            <!-- پنل اتصالات -->
            <div class="connection-panel" id="connectionPanel">
                <div class="connection-title">
                    <i class="fas fa-project-diagram"></i>
                    شبکه معنایی
                </div>
                <div class="connection-message" id="connectionMessage">
                    اشیاء را به هم وصل کنید تا پیام‌های پنهان را کشف کنید...
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="move-btn" style="flex: 1;" id="clearConnections">
                        <i class="fas fa-trash"></i> پاک کردن
                    </button>
                    <button class="move-btn" style="flex: 1; background: rgba(46, 204, 113, 0.3);" id="saveConnections">
                        <i class="fas fa-save"></i> ذخیره
                    </button>
                </div>
            </div>
            
            <!-- نوار دستورات -->
            <div class="command-bar" id="commandBar">
                <input type="text" class="command-input" id="commandInput" placeholder="دستور خود را وارد کنید (مثال: /connect یا /reveal)..." autocomplete="off">
            </div>
            
            <!-- موزیک پلیر -->
            <div class="music-player-3d">
                <button class="move-btn" id="musicToggle">
                    <i class="fas fa-play" id="musicIcon"></i>
                </button>
                <div style="color: #2ecc71; font-size: 0.9rem;">
                    <div id="musicTitle">Demur Soundscape</div>
                    <input type="range" min="0" max="100" value="50" id="volumeSlider" style="width: 100px;">
                </div>
            </div>
            
            <!-- دکمه VR -->
            <button class="vr-toggle" id="vrToggle">
                <i class="fas fa-vr-cardboard"></i>
                حالت سه‌بعدی
            </button>
        </div>
        
        <!-- رابط اتصالات -->
        <div class="connection-ui" id="connectionUI"></div>
        
        <!-- اعلان‌ها -->
        <div class="notification-3d" id="notification3d">
            <div style="text-align: center;">
                <div style="font-size: 3rem; color: #2ecc71; margin-bottom: 20px;">
                    <i class="fas fa-bullseye"></i>
                </div>
                <h2 id="notificationTitle">کشف جدید!</h2>
                <p id="notificationText">شیء جدیدی پیدا کردید</p>
            </div>
        </div>
    </div>
    
    <!-- صداها -->
    <audio id="ambient-music" loop>
        <source src="https://raw.githubusercontent.com/abolfazl140122/Demur/018d52042cb43d84da7c17daf49f35da735bd3e9/%D9%85%D9%88%D8%B2%DB%8C%DA%A9%20%D8%A8%D8%AF%20%DA%AF%D8%B1%D8%A7%D9%86%D8%AF%20%D8%B5%D9%81%D9%87%20%D9%84%D9%88%D8%AF%DB%8C%D9%86%DA%AF%20%D8%A7%DB%8C%D8%B3%D8%AA%D8%A7%D8%AF%D9%87.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="interaction-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="connection-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="portal-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-whoosh-flashback-1155.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ==================== سیستم اصلی بازی سه‌بعدی ====================
        const PsychedelicWorld = {
            // وضعیت بازی
            state: {
                consciousness: 25,
                connections: [],
                discoveredObjects: [],
                inventory: [],
                currentWorld: 'void',
                playerPosition: { x: 0, y: 0, z: 0 },
                playerRotation: { x: 0, y: 0 },
                velocity: { x: 0, y: 0, z: 0 },
                isFlying: true,
                gravity: 0.5,
                selectedObject: null,
                insightLevel: 1,
                isConnecting: false,
                connectionStart: null
            },
            
            // تنظیمات Three.js
            scene: null,
            camera: null,
            renderer: null,
            controls: null,
            clock: new THREE.Clock(),
            
            // اشیاء سه‌بعدی
            objects: [],
            floatingWords: [],
            particles: [],
            
            // نورها
            lights: [],
            
            // صداها
            audio: {
                ambient: null,
                interaction: null,
                connection: null,
                portal: null
            },
            
            // کنترل‌های کیبورد
            keys: {},
            
            // کلمات و نمادها
            symbols: [
                { text: 'عشق', color: '#e74c3c', type: 'emotion' },
                { text: 'مرگ', color: '#3498db', type: 'concept' },
                { text: 'آزادی', color: '#2ecc71', type: 'concept' },
                { text: 'ترس', color: '#9b59b6', type: 'emotion' },
                { text: 'حقیقت', color: '#f1c40f', type: 'concept' },
                { text: 'خود', color: '#1abc9c', type: 'self' },
                { text: 'سایه', color: '#34495e', type: 'shadow' },
                { text: 'نقاب', color: '#95a5a6', type: 'mask' },
                { text: 'رنج', color: '#e67e22', type: 'emotion' },
                { text: 'امید', color: '#e84393', type: 'emotion' }
            ],
            
            // پیام‌های ممکن از اتصال کلمات
            messages: [
                'عشق بر مرگ غلبه می‌کند',
                'آزادی در پذیرش خود است',
                'ترس سایه‌ای از ناشناخته‌هاست',
                'حقیقت زیر نقاب‌ها پنهان است',
                'رنج معنا می‌آفریند',
                'امید در تاریکی می‌درخشد',
                'خود واقعی پشت سایه‌هاست',
                'آزادی از ترس آغاز می‌شود'
            ],
            
            // ==================== مقداردهی اولیه ====================
            init() {
                this.setupScene();
                this.setupLights();
                this.setupFloor();
                this.createFloatingObjects();
                this.createParticleSystem();
                this.setupEventListeners();
                this.setupAudio();
                this.startLoading();
            },
            
            // راه‌اندازی صحنه Three.js
            setupScene() {
                // ایجاد صحنه
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.Fog(0x000000, 50, 500);
                
                // ایجاد دوربین
                this.camera = new THREE.PerspectiveCamera(
                    75,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    1000
                );
                this.camera.position.set(0, 10, 20);
                
                // ایجاد رندرر
                this.renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: true 
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                document.getElementById('scene-container').appendChild(this.renderer.domElement);
                
                // کنترل‌های دوربین
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.screenSpacePanning = false;
                this.controls.minDistance = 5;
                this.controls.maxDistance = 200;
                this.controls.maxPolarAngle = Math.PI;
            },
            
            // ایجاد نورها
            setupLights() {
                // نور محیطی
                const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
                this.scene.add(ambientLight);
                this.lights.push(ambientLight);
                
                // نور جهت‌دار
                const directionalLight = new THREE.DirectionalLight(0x2ecc71, 1);
                directionalLight.position.set(10, 20, 5);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);
                this.lights.push(directionalLight);
                
                // نور نقطه‌ای
                const pointLight = new THREE.PointLight(0x3498db, 2, 100);
                pointLight.position.set(0, 10, 0);
                this.scene.add(pointLight);
                this.lights.push(pointLight);
                
                // نورهای رنگی متحرک
                const colors = [0xe74c3c, 0x2ecc71, 0x3498db, 0xf1c40f, 0x9b59b6];
                colors.forEach((color, i) => {
                    const light = new THREE.PointLight(color, 1, 50);
                    light.position.set(
                        Math.cos(i * Math.PI * 0.4) * 30,
                        10,
                        Math.sin(i * Math.PI * 0.4) * 30
                    );
                    this.scene.add(light);
                    this.lights.push(light);
                });
            },
            
            // ایجاد زمین
            setupFloor() {
                // زمین شفاف
                const floorGeometry = new THREE.PlaneGeometry(500, 500);
                const floorMaterial = new THREE.MeshBasicMaterial({
                    color: 0x000000,
                    transparent: true,
                    opacity: 0.1,
                    side: THREE.DoubleSide
                });
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = Math.PI / 2;
                floor.position.y = -5;
                this.scene.add(floor);
                
                // شبکه هندسی
                const gridHelper = new THREE.GridHelper(500, 100, 0x2ecc71, 0x1a1a1a);
                gridHelper.material.transparent = true;
                gridHelper.material.opacity = 0.2;
                this.scene.add(gridHelper);
            },
            
            // ایجاد اشیاء شناور
            createFloatingObjects() {
                // ایجاد کلمات سه‌بعدی
                this.symbols.forEach((symbol, index) => {
                    this.createWordObject(symbol, index);
                });
                
                // ایجاد اشیاء هندسی
                const geometries = [
                    new THREE.TetrahedronGeometry(2),
                    new THREE.OctahedronGeometry(3),
                    new THREE.DodecahedronGeometry(3),
                    new THREE.IcosahedronGeometry(3),
                    new THREE.TorusKnotGeometry(2, 0.5, 100, 16),
                    new THREE.TorusGeometry(3, 1, 16, 100)
                ];
                
                geometries.forEach((geometry, i) => {
                    const material = new THREE.MeshPhongMaterial({
                        color: new THREE.Color(`hsl(${i * 60}, 70%, 60%)`),
                        emissive: new THREE.Color(`hsl(${i * 60}, 70%, 20%)`),
                        shininess: 100,
                        transparent: true,
                        opacity: 0.8
                    });
                    
                    const mesh = new THREE.Mesh(geometry, material);
                    
                    // موقعیت تصادفی
                    const angle = Math.random() * Math.PI * 2;
                    const radius = 20 + Math.random() * 30;
                    mesh.position.set(
                        Math.cos(angle) * radius,
                        Math.random() * 20 - 5,
                        Math.sin(angle) * radius
                    );
                    
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    mesh.userData = {
                        type: 'geometry',
                        id: `geo_${i}`,
                        draggable: true,
                        symbol: this.symbols[i % this.symbols.length]
                    };
                    
                    this.scene.add(mesh);
                    this.objects.push(mesh);
                });
            },
            
            // ایجاد کلمات سه‌بعدی
            createWordObject(symbol, index) {
                // استفاده از Canvas برای ایجاد متن
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 256;
                canvas.height = 128;
                
                // پس زمینه
                context.fillStyle = 'rgba(0, 0, 0, 0.7)';
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                // متن
                context.font = 'bold 60px Vazirmatn';
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillStyle = symbol.color;
                context.fillText(symbol.text, canvas.width / 2, canvas.height / 2);
                
                // سایه
                context.shadowColor = symbol.color;
                context.shadowBlur = 20;
                context.fillText(symbol.text, canvas.width / 2, canvas.height / 2);
                
                // ایجاد بافت
                const texture = new THREE.CanvasTexture(canvas);
                texture.needsUpdate = true;
                
                // ایجاد صفحه برای نمایش متن
                const geometry = new THREE.PlaneGeometry(10, 5);
                const material = new THREE.MeshBasicMaterial({
                    map: texture,
                    transparent: true,
                    side: THREE.DoubleSide,
                    emissive: new THREE.Color(symbol.color),
                    emissiveIntensity: 0.5
                });
                
                const mesh = new THREE.Mesh(geometry, material);
                
                // موقعیت تصادفی
                const angle = (index / this.symbols.length) * Math.PI * 2;
                const radius = 15 + Math.random() * 20;
                mesh.position.set(
                    Math.cos(angle) * radius,
                    Math.random() * 15,
                    Math.sin(angle) * radius
                );
                
                // ذخیره داده‌های کاربر
                mesh.userData = {
                    type: 'word',
                    text: symbol.text,
                    color: symbol.color,
                    symbolType: symbol.type,
                    id: `word_${index}`,
                    draggable: true,
                    selected: false
                };
                
                this.scene.add(mesh);
                this.floatingWords.push(mesh);
            },
            
            // ایجاد سیستم ذرات
            createParticleSystem() {
                const particleCount = 5000;
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(particleCount * 3);
                const colors = new Float32Array(particleCount * 3);
                const sizes = new Float32Array(particleCount);
                
                for (let i = 0; i < particleCount; i++) {
                    // موقعیت‌های تصادفی در یک کره
                    const radius = 50 + Math.random() * 100;
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    
                    positions[i * 3] = radius * Math.sin(phi) * Math.cos(theta);
                    positions[i * 3 + 1] = radius * Math.sin(phi) * Math.sin(theta);
                    positions[i * 3 + 2] = radius * Math.cos(phi);
                    
                    // رنگ‌های تصادفی
                    colors[i * 3] = Math.random() * 0.5 + 0.5; // قرمز
                    colors[i * 3 + 1] = Math.random() * 0.5 + 0.5; // سبز
                    colors[i * 3 + 2] = Math.random() * 0.5 + 0.5; // آبی
                    
                    sizes[i] = Math.random() * 2;
                }
                
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
                
                const material = new THREE.PointsMaterial({
                    size: 0.1,
                    vertexColors: true,
                    transparent: true,
                    opacity: 0.6,
                    blending: THREE.AdditiveBlending
                });
                
                const particles = new THREE.Points(geometry, material);
                this.scene.add(particles);
                this.particles.push(particles);
            },
            
            // تنظیم رویدادها
            setupEventListeners() {
                // رویدادهای پنجره
                window.addEventListener('resize', () => this.onWindowResize());
                
                // رویدادهای کیبورد
                window.addEventListener('keydown', (e) => this.onKeyDown(e));
                window.addEventListener('keyup', (e) => this.onKeyUp(e));
                
                // رویدادهای موس
                this.renderer.domElement.addEventListener('mousedown', (e) => this.onMouseDown(e));
                this.renderer.domElement.addEventListener('mousemove', (e) => this.onMouseMove(e));
                this.renderer.domElement.addEventListener('mouseup', (e) => this.onMouseUp(e));
                this.renderer.domElement.addEventListener('click', (e) => this.onClick(e));
                this.renderer.domElement.addEventListener('wheel', (e) => this.onMouseWheel(e));
                this.renderer.domElement.addEventListener('contextmenu', (e) => e.preventDefault());
                
                // رویدادهای کنترل‌های UI
                this.setupUIControls();
                
                // رویداد کلیک برای فعال کردن صدا
                document.addEventListener('click', () => this.activateAudio(), { once: true });
            },
            
            // تنظیم کنترل‌های UI
            setupUIControls() {
                // کنترل‌های حرکت
                document.querySelectorAll('.move-btn').forEach(btn => {
                    btn.addEventListener('mousedown', (e) => {
                        const action = e.currentTarget.dataset.action;
                        this.keys[action] = true;
                    });
                    
                    btn.addEventListener('mouseup', (e) => {
                        const action = e.currentTarget.dataset.action;
                        this.keys[action] = false;
                    });
                    
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const action = e.currentTarget.dataset.action;
                        this.keys[action] = true;
                    });
                    
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        const action = e.currentTarget.dataset.action;
                        this.keys[action] = false;
                    });
                });
                
                // کنترل‌های اصلی
                document.getElementById('actionBtn').addEventListener('click', () => this.performAction());
                document.getElementById('interactBtn').addEventListener('click', () => this.interactWithObject());
                document.getElementById('abilityBtn').addEventListener('click', () => this.useAbility());
                document.getElementById('inventoryBtn').addEventListener('click', () => this.toggleInventory());
                document.getElementById('crouchBtn').addEventListener('click', () => this.toggleCrouch());
                document.getElementById('runBtn').addEventListener('click', () => this.toggleRun());
                document.getElementById('flashlightBtn').addEventListener('click', () => this.toggleFlashlight());
                document.getElementById('mapBtn').addEventListener('click', () => this.showMap());
                
                // نویگیشن جهان‌ها
                document.querySelectorAll('.nav-portal').forEach(portal => {
                    portal.addEventListener('click', (e) => {
                        const world = e.currentTarget.dataset.world;
                        this.changeWorld(world);
                    });
                });
                
                // پنل اتصالات
                document.getElementById('clearConnections').addEventListener('click', () => this.clearConnections());
                document.getElementById('saveConnections').addEventListener('click', () => this.saveConnections());
                
                // موزیک پلیر
                document.getElementById('musicToggle').addEventListener('click', () => this.toggleMusic());
                document.getElementById('volumeSlider').addEventListener('input', (e) => {
                    if (this.audio.ambient) {
                        this.audio.ambient.volume = e.target.value / 100;
                    }
                });
                
                // دکمه VR
                document.getElementById('vrToggle').addEventListener('click', () => this.toggleVR());
                
                // نوار دستورات
                document.addEventListener('keydown', (e) => {
                    if (e.key === '/' && !e.ctrlKey && !e.altKey) {
                        e.preventDefault();
                        this.toggleCommandBar();
                    }
                    
                    if (e.key === 'Escape') {
                        this.hideCommandBar();
                        this.hideConnectionPanel();
                    }
                });
                
                document.getElementById('commandInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.executeCommand(e.target.value);
                        e.target.value = '';
                        this.hideCommandBar();
                    }
                });
            },
            
            // فعال کردن صدا
            activateAudio() {
                if (this.audio.ambient) {
                    this.audio.ambient.volume = 0.3;
                    this.audio.ambient.play();
                }
            },
            
            // تنظیم صداها
            setupAudio() {
                this.audio = {
                    ambient: document.getElementById('ambient-music'),
                    interaction: document.getElementById('interaction-sound'),
                    connection: document.getElementById('connection-sound'),
                    portal: document.getElementById('portal-sound')
                };
            },
            
            // شروع لودینگ
            startLoading() {
                let progress = 0;
                const loadingInterval = setInterval(() => {
                    progress += Math.random() * 15 + 5;
                    if (progress > 100) {
                        progress = 100;
                        clearInterval(loadingInterval);
                        
                        setTimeout(() => {
                            document.getElementById('loading-screen').style.opacity = '0';
                            setTimeout(() => {
                                document.getElementById('loading-screen').style.display = 'none';
                                document.getElementById('game-container').style.display = 'block';
                                this.startGame();
                            }, 1000);
                        }, 500);
                    }
                }, 200);
            },
            
            // شروع بازی
            startGame() {
                this.animate();
                this.updateUI();
                this.showNotification('به جهان روانی Demur خوش آمدید!', 'از کلیدهای WASD برای حرکت و موس برای نگاه کردن استفاده کنید.');
            },
            
            // ==================== انیمیشن و حلقه بازی ====================
            animate() {
                requestAnimationFrame(() => this.animate());
                
                const delta = this.clock.getDelta();
                
                // به‌روزرسانی کنترل‌ها
                this.controls.update();
                
                // حرکت دوربین (اگر حالت پرواز فعال باشد)
                if (this.state.isFlying) {
                    this.updateCameraMovement(delta);
                }
                
                // انیمیشن اشیاء شناور
                this.animateFloatingObjects(delta);
                
                // انیمیشن ذرات
                this.animateParticles(delta);
                
                // انیمیشن نورها
                this.animateLights(delta);
                
                // رندر صحنه
                this.renderer.render(this.scene, this.camera);
                
                // به‌روزرسانی UI
                this.updateUI();
                
                // بررسی برخورد
                this.checkInteractions();
            },
            
            // حرکت دوربین
            updateCameraMovement(delta) {
                const speed = 20 * delta;
                const moveSpeed = this.keys['Shift'] ? speed * 2 : speed;
                
                if (this.keys['forward'] || this.keys['w'] || this.keys['W']) {
                    this.camera.translateZ(-moveSpeed);
                }
                if (this.keys['backward'] || this.keys['s'] || this.keys['S']) {
                    this.camera.translateZ(moveSpeed);
                }
                if (this.keys['left'] || this.keys['a'] || this.keys['A']) {
                    this.camera.translateX(-moveSpeed);
                }
                if (this.keys['right'] || this.keys['d'] || this.keys['D']) {
                    this.camera.translateX(moveSpeed);
                }
                if (this.keys['jump'] || this.keys[' ']) {
                    this.camera.position.y += moveSpeed;
                }
                if (this.keys['crouch'] || this.keys['c'] || this.keys['C']) {
                    this.camera.position.y -= moveSpeed;
                }
                
                // اعمال گرانش اگر پرواز غیرفعال باشد
                if (!this.state.isFlying) {
                    this.state.velocity.y -= this.state.gravity * delta;
                    this.camera.position.y += this.state.velocity.y;
                    
                    // محدودیت ارتفاع
                    if (this.camera.position.y < 5) {
                        this.camera.position.y = 5;
                        this.state.velocity.y = 0;
                    }
                }
            },
            
            // انیمیشن اشیاء شناور
            animateFloatingObjects(delta) {
                this.floatingWords.forEach((word, index) => {
                    word.rotation.y += delta * 0.5;
                    word.position.y += Math.sin(Date.now() * 0.001 + index) * 0.01;
                    
                    // حرکت دورانی
                    const time = Date.now() * 0.001;
                    const radius = 20;
                    word.position.x = Math.cos(time * 0.3 + index) * radius;
                    word.position.z = Math.sin(time * 0.3 + index) * radius;
                });
                
                this.objects.forEach((obj, index) => {
                    obj.rotation.x += delta * 0.3;
                    obj.rotation.y += delta * 0.5;
                    obj.rotation.z += delta * 0.2;
                    
                    // حرکت شناور
                    obj.position.y += Math.sin(Date.now() * 0.001 + index * 2) * 0.02;
                });
            },
            
            // انیمیشن ذرات
            animateParticles(delta) {
                this.particles.forEach(particle => {
                    particle.rotation.y += delta * 0.1;
                });
            },
            
            // انیمیشن نورها
            animateLights(delta) {
                this.lights.forEach((light, index) => {
                    if (light instanceof THREE.PointLight) {
                        const time = Date.now() * 0.001;
                        const radius = 25;
                        light.position.x = Math.cos(time * 0.5 + index) * radius;
                        light.position.z = Math.sin(time * 0.5 + index) * radius;
                        light.position.y = 10 + Math.sin(time * 0.7 + index) * 5;
                        
                        // تغییر شدت نور
                        light.intensity = 1 + Math.sin(time * 2 + index) * 0.5;
                    }
                });
            },
            
            // ==================== تعاملات ====================
            onKeyDown(e) {
                this.keys[e.key.toLowerCase()] = true;
                
                // جلوگیری از اسکرول با Space
                if (e.key === ' ') {
                    e.preventDefault();
                }
                
                // کنترل‌های ویژه
                switch(e.key.toLowerCase()) {
                    case 'f':
                        this.toggleFlashlight();
                        break;
                    case 'e':
                        this.interactWithObject();
                        break;
                    case 'q':
                        this.useAbility();
                        break;
                    case 'tab':
                        e.preventDefault();
                        this.toggleInventory();
                        break;
                    case 'shift':
                        this.state.isRunning = true;
                        break;
                    case 'c':
                        this.toggleCrouch();
                        break;
                    case 'm':
                        this.showMap();
                        break;
                    case 'g':
                        this.grabObject();
                        break;
                    case 'v':
                        this.toggleVR();
                        break;
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                    case '5':
                        this.selectAbility(parseInt(e.key));
                        break;
                }
            },
            
            onKeyUp(e) {
                this.keys[e.key.toLowerCase()] = false;
                
                if (e.key === 'Shift') {
                    this.state.isRunning = false;
                }
            },
            
            onMouseDown(e) {
                e.preventDefault();
                
                // کلیک چپ برای انتخاب
                if (e.button === 0) {
                    this.selectObjectAtMouse(e.clientX, e.clientY);
                }
                
                // کلیک راست برای شروع اتصال
                if (e.button === 2) {
                    this.startConnection(e.clientX, e.clientY);
                }
                
                // کلیک وسط برای دستورات
                if (e.button === 1) {
                    this.toggleCommandBar();
                }
            },
            
            onMouseMove(e) {
                if (this.state.isConnecting && this.state.connectionStart) {
                    this.updateConnectionLine(e.clientX, e.clientY);
                }
                
                // حرکت اشیاء انتخاب شده
                if (this.state.selectedObject && this.keys['g']) {
                    this.dragObject(e.clientX, e.clientY);
                }
            },
            
            onMouseUp(e) {
                if (e.button === 2 && this.state.isConnecting) {
                    this.finishConnection(e.clientX, e.clientY);
                }
                
                if (e.button === 0 && this.state.selectedObject) {
                    this.dropObject();
                }
            },
            
            onClick(e) {
                // کلیک روی اشیاء
                const object = this.getObjectAtMouse(e.clientX, e.clientY);
                if (object) {
                    this.onObjectClick(object);
                }
            },
            
            onMouseWheel(e) {
                e.preventDefault();
                const zoomSpeed = 0.1;
                this.camera.fov += e.deltaY * zoomSpeed;
                this.camera.fov = Math.max(10, Math.min(100, this.camera.fov));
                this.camera.updateProjectionMatrix();
            },
            
            // انتخاب شیء با موس
            selectObjectAtMouse(x, y) {
                const object = this.getObjectAtMouse(x, y);
                if (object && object.userData.draggable) {
                    this.selectObject(object);
                }
            },
            
            getObjectAtMouse(x, y) {
                const mouse = new THREE.Vector2();
                const rect = this.renderer.domElement.getBoundingClientRect();
                
                mouse.x = ((x - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((y - rect.top) / rect.height) * 2 + 1;
                
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, this.camera);
                
                const objects = [...this.floatingWords, ...this.objects];
                const intersects = raycaster.intersectObjects(objects);
                
                return intersects.length > 0 ? intersects[0].object : null;
            },
            
            // کلیک روی شیء
            onObjectClick(object) {
                const userData = object.userData;
                
                if (userData.type === 'word') {
                    this.discoverWord(userData.text, userData.color);
                    this.showNotification(`کلمه "${userData.text}" کشف شد!`, 'آن را با کلمات دیگر وصل کنید.');
                    
                    // افکت بصری
                    this.pulseObject(object, userData.color);
                } else if (userData.type === 'geometry') {
                    this.discoverObject(userData.id, userData.symbol);
                }
                
                this.playSound('interaction');
            },
            
            // کشف کلمه
            discoverWord(word, color) {
                if (!this.state.discoveredObjects.includes(word)) {
                    this.state.discoveredObjects.push(word);
                    this.state.consciousness += 5;
                    
                    // افزودن به اینونتوری
                    this.addToInventory(word, color);
                    
                    // به‌روزرسانی UI
                    this.updateUI();
                }
            },
            
            // کشف شیء
            discoverObject(id, symbol) {
                if (!this.state.discoveredObjects.includes(id)) {
                    this.state.discoveredObjects.push(id);
                    this.state.consciousness += 10;
                    this.state.insightLevel = Math.floor(this.state.consciousness / 25) + 1;
                    
                    this.addToInventory(symbol.text, symbol.color);
                    this.updateUI();
                    
                    this.showNotification('شیء جدید کشف شد!', `بینش شما به سطح ${this.state.insightLevel} رسید.`);
                }
            },
            
            // افزودن به اینونتوری
            addToInventory(item, color) {
                this.state.inventory.push({ item, color });
                
                const inventoryGrid = document.getElementById('inventoryGrid');
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.innerHTML = `<i class="fas fa-hashtag"></i>`;
                itemElement.style.color = color;
                itemElement.style.borderColor = color;
                itemElement.title = item;
                itemElement.draggable = true;
                
                itemElement.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item);
                    this.state.selectedObject = item;
                });
                
                inventoryGrid.appendChild(itemElement);
            },
            
            // ==================== سیستم اتصال ====================
            startConnection(x, y) {
                const object = this.getObjectAtMouse(x, y);
                if (object && object.userData.type === 'word') {
                    this.state.isConnecting = true;
                    this.state.connectionStart = {
                        object: object,
                        x: x,
                        y: y,
                        worldPos: object.position.clone()
                    };
                    
                    this.showConnectionPanel();
                }
            },
            
            updateConnectionLine(x, y) {
                const connectionUI = document.getElementById('connectionUI');
                connectionUI.innerHTML = '';
                
                const rect = this.renderer.domElement.getBoundingClientRect();
                const startX = this.state.connectionStart.x - rect.left;
                const startY = this.state.connectionStart.y - rect.top;
                
                const line = document.createElement('div');
                line.className = 'connection-line';
                
                // محاسبه طول و زاویه خط
                const dx = x - rect.left - startX;
                const dy = y - rect.top - startY;
                const length = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                line.style.width = `${length}px`;
                line.style.left = `${startX}px`;
                line.style.top = `${startY}px`;
                line.style.transform = `rotate(${angle}deg)`;
                line.style.background = `linear-gradient(90deg, ${this.state.connectionStart.object.userData.color}, transparent)`;
                
                connectionUI.appendChild(line);
            },
            
            finishConnection(x, y) {
                const endObject = this.getObjectAtMouse(x, y);
                
                if (endObject && endObject.userData.type === 'word' && 
                    endObject !== this.state.connectionStart.object) {
                    
                    // ایجاد اتصال
                    this.createConnection(
                        this.state.connectionStart.object,
                        endObject
                    );
                    
                    this.playSound('connection');
                }
                
                this.state.isConnecting = false;
                this.state.connectionStart = null;
                document.getElementById('connectionUI').innerHTML = '';
            },
            
            createConnection(startObject, endObject) {
                const connection = {
                    start: startObject.userData.id,
                    end: endObject.userData.id,
                    startWord: startObject.userData.text,
                    endWord: endObject.userData.text,
                    color: startObject.userData.color,
                    strength: 1
                };
                
                this.state.connections.push(connection);
                this.state.consciousness += 2;
                
                // ایجاد خط سه‌بعدی بین اشیاء
                this.create3DConnection(startObject.position, endObject.position, connection.color);
                
                // بررسی پیام جدید
                this.checkForMessage(connection);
                
                // به‌روزرسانی UI
                this.updateUI();
            },
            
            create3DConnection(startPos, endPos, color) {
                const points = [
                    new THREE.Vector3(startPos.x, startPos.y, startPos.z),
                    new THREE.Vector3(endPos.x, endPos.y, endPos.z)
                ];
                
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({ 
                    color: new THREE.Color(color),
                    linewidth: 3,
                    transparent: true,
                    opacity: 0.7
                });
                
                const line = new THREE.Line(geometry, material);
                this.scene.add(line);
                
                // انیمیشن پالس
                let pulse = 0;
                const animatePulse = () => {
                    pulse += 0.05;
                    material.opacity = 0.3 + Math.sin(pulse) * 0.4;
                    
                    if (pulse < Math.PI * 4) {
                        requestAnimationFrame(animatePulse);
                    }
                };
                animatePulse();
            },
            
            checkForMessage(connection) {
                const words = [connection.startWord, connection.endWord];
                
                // بررسی اگر این اتصال بخشی از یک پیام است
                this.messages.forEach(message => {
                    const messageWords = message.split(' ');
                    if (messageWords.some(w => words.includes(w))) {
                        // نشان دادن پیام
                        this.showMessage(message);
                    }
                });
            },
            
            showMessage(message) {
                const messageElement = document.getElementById('connectionMessage');
                const words = message.split(' ');
                
                messageElement.innerHTML = words.map(word => {
                    const color = this.symbols.find(s => s.text === word)?.color || '#2ecc71';
                    return `<span class="message-word" style="border-color: ${color}; color: ${color}">${word}</span>`;
                }).join(' ');
                
                this.showNotification('پیام جدید کشف شد!', 'معنی پنهان را آشکار کردید.');
            },
            
            clearConnections() {
                this.state.connections = [];
                // حذف خطوط از صحنه
                this.scene.children = this.scene.children.filter(child => 
                    !(child instanceof THREE.Line)
                );
                this.updateUI();
            },
            
            saveConnections() {
                const data = {
                    connections: this.state.connections,
                    consciousness: this.state.consciousness,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('demur_connections', JSON.stringify(data));
                this.showNotification('اتصالات ذخیره شدند!', 'می‌توانید بعداً ادامه دهید.');
            },
            
            // ==================== توانایی‌ها ====================
            useAbility() {
                const abilities = [
                    { name: 'درون‌بینی', effect: 'reveal' },
                    { name: 'سایه‌گردی', effect: 'shadow' },
                    { name: 'نورافشانی', effect: 'light' },
                    { name: 'پرواز روانی', effect: 'flight' },
                    { name: 'ایجاد پیوند', effect: 'bond' }
                ];
                
                const ability = abilities[this.state.insightLevel - 1] || abilities[0];
                this.activateAbility(ability);
            },
            
            activateAbility(ability) {
                switch(ability.effect) {
                    case 'reveal':
                        this.revealHiddenObjects();
                        break;
                    case 'shadow':
                        this.toggleShadows();
                        break;
                    case 'light':
                        this.createLightExplosion();
                        break;
                    case 'flight':
                        this.toggleFlight();
                        break;
                    case 'bond':
                        this.createRandomConnection();
                        break;
                }
                
                this.showNotification(`توانایی "${ability.name}" فعال شد!`, 'اثر آن را در جهان ببینید.');
            },
            
            revealHiddenObjects() {
                // نشان دادن اشیاء پنهان
                this.objects.forEach(obj => {
                    if (obj.material) {
                        obj.material.opacity = 1;
                        obj.material.transparent = false;
                    }
                });
                
                // افکت نور
                const flash = new THREE.PointLight(0xffffff, 5, 50);
                flash.position.copy(this.camera.position);
                this.scene.add(flash);
                
                setTimeout(() => {
                    this.scene.remove(flash);
                }, 500);
            },
            
            toggleShadows() {
                this.renderer.shadowMap.enabled = !this.renderer.shadowMap.enabled;
                this.showNotification(`سایه‌ها ${this.renderer.shadowMap.enabled ? 'فعال' : 'غیرفعال'} شدند`);
            },
            
            createLightExplosion() {
                for (let i = 0; i < 10; i++) {
                    const light = new THREE.PointLight(
                        new THREE.Color(`hsl(${Math.random() * 360}, 100%, 50%)`),
                        3,
                        30
                    );
                    
                    light.position.set(
                        Math.random() * 50 - 25,
                        Math.random() * 30,
                        Math.random() * 50 - 25
                    );
                    
                    this.scene.add(light);
                    
                    // حذف تدریجی
                    setTimeout(() => {
                        this.scene.remove(light);
                    }, 1000 + Math.random() * 1000);
                }
            },
            
            toggleFlight() {
                this.state.isFlying = !this.state.isFlying;
                this.showNotification(`حالت پرواز ${this.state.isFlying ? 'فعال' : 'غیرفعال'} شد`);
            },
            
            createRandomConnection() {
                if (this.floatingWords.length >= 2) {
                    const word1 = this.floatingWords[Math.floor(Math.random() * this.floatingWords.length)];
                    const word2 = this.floatingWords[Math.floor(Math.random() * this.floatingWords.length)];
                    
                    if (word1 !== word2) {
                        this.createConnection(word1, word2);
                    }
                }
            },
            
            // ==================== تعاملات جهان ====================
            changeWorld(worldName) {
                this.playSound('portal');
                
                // افکت انتقال
                this.createPortalEffect();
                
                // تغییر جهان
                this.state.currentWorld = worldName;
                
                // تغییر رنگ محیط
                const worldColors = {
                    void: '#2ecc71',
                    mountains: '#e67e22',
                    ocean: '#3498db',
                    temple: '#9b59b6'
                };
                
                this.changeWorldColor(worldColors[worldName] || '#2ecc71');
                
                setTimeout(() => {
                    this.showNotification(`به جهان "${this.getWorldName(worldName)}" خوش آمدید!`, 'کاوش را ادامه دهید.');
                }, 1000);
            },
            
            getWorldName(worldKey) {
                const names = {
                    void: 'خالی‌گاه',
                    mountains: 'کوهستان اراده',
                    ocean: 'اقیانوس ناخودآگاه',
                    temple: 'معبد حقیقت'
                };
                return names[worldKey] || 'جهان ناشناخته';
            },
            
            changeWorldColor(color) {
                // تغییر رنگ نورها
                this.lights.forEach(light => {
                    if (light instanceof THREE.DirectionalLight) {
                        light.color.set(color);
                    }
                });
                
                // تغییر رنگ مه
                this.scene.fog.color.set(color);
            },
            
            createPortalEffect() {
                // ایجاد ذرات پورتال
                const particleCount = 100;
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(particleCount * 3);
                
                for (let i = 0; i < particleCount * 3; i += 3) {
                    positions[i] = Math.random() * 10 - 5;
                    positions[i + 1] = Math.random() * 10 - 5;
                    positions[i + 2] = Math.random() * 10 - 5;
                }
                
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                
                const material = new THREE.PointsMaterial({
                    color: 0x2ecc71,
                    size: 0.5,
                    transparent: true,
                    opacity: 0.8
                });
                
                const particles = new THREE.Points(geometry, material);
                particles.position.copy(this.camera.position);
                this.scene.add(particles);
                
                // انیمیشن ذرات
                let time = 0;
                const animatePortal = () => {
                    time += 0.1;
                    
                    for (let i = 0; i < particleCount * 3; i += 3) {
                        geometry.attributes.position.array[i] += Math.sin(time + i) * 0.1;
                        geometry.attributes.position.array[i + 1] += Math.cos(time + i) * 0.1;
                        geometry.attributes.position.array[i + 2] += Math.sin(time * 0.5 + i) * 0.1;
                    }
                    
                    geometry.attributes.position.needsUpdate = true;
                    
                    if (time < 3) {
                        requestAnimationFrame(animatePortal);
                    } else {
                        this.scene.remove(particles);
                    }
                };
                
                animatePortal();
            },
            
            // ==================== دستورات ====================
            toggleCommandBar() {
                const commandBar = document.getElementById('commandBar');
                const commandInput = document.getElementById('commandInput');
                
                if (commandBar.style.display === 'block') {
                    commandBar.style.display = 'none';
                } else {
                    commandBar.style.display = 'block';
                    commandInput.focus();
                }
            },
            
            hideCommandBar() {
                document.getElementById('commandBar').style.display = 'none';
            },
            
            executeCommand(command) {
                const cmd = command.trim().toLowerCase();
                
                if (cmd.startsWith('/connect')) {
                    this.connectRandomWords();
                } else if (cmd.startsWith('/reveal')) {
                    this.revealHiddenObjects();
                } else if (cmd.startsWith('/light')) {
                    this.createLightExplosion();
                } else if (cmd.startsWith('/fly')) {
                    this.toggleFlight();
                } else if (cmd.startsWith('/clear')) {
                    this.clearConnections();
                } else if (cmd.startsWith('/help')) {
                    this.showHelp();
                } else if (cmd.startsWith('/msg')) {
                    const message = cmd.replace('/msg', '').trim();
                    if (message) {
                        this.showMessage(message);
                    }
                } else {
                    this.showNotification('دستور نامعتبر', 'از /help برای راهنما استفاده کنید');
                }
            },
            
            connectRandomWords() {
                if (this.floatingWords.length >= 2) {
                    const word1 = this.floatingWords[Math.floor(Math.random() * this.floatingWords.length)];
                    const word2 = this.floatingWords[Math.floor(Math.random() * this.floatingWords.length)];
                    
                    if (word1 !== word2) {
                        this.createConnection(word1, word2);
                        this.showNotification('اتصال ایجاد شد!', 'دو کلمه به هم متصل شدند.');
                    }
                }
            },
            
            showHelp() {
                const helpText = `
دستورات موجود:
/connect - اتصال دو کلمه تصادفی
/reveal - آشکارسازی اشیاء پنهان
/light - ایجاد انفجار نور
/fly - تغییر حالت پرواز
/clear - پاک کردن اتصالات
/msg [متن] - ایجاد پیام
/help - نمایش این راهنما
                `;
                
                this.showNotification('راهنمای دستورات', helpText);
            },
            
            // ==================== UI ====================
            updateUI() {
                // به‌روزرسانی نوار آگاهی
                document.getElementById('consciousnessFill').style.width = `${this.state.consciousness}%`;
                
                // به‌روزرسانی آمار
                document.getElementById('connectionCount').textContent = this.state.connections.length;
                document.getElementById('objectCount').textContent = this.state.discoveredObjects.length;
                document.getElementById('insightLevel').textContent = this.state.insightLevel;
                
                // تغییر رنگ نوار بر اساس سطح آگاهی
                const consciousnessFill = document.getElementById('consciousnessFill');
                if (this.state.consciousness < 30) {
                    consciousnessFill.style.background = 'linear-gradient(90deg, #e74c3c, #e67e22)';
                } else if (this.state.consciousness < 70) {
                    consciousnessFill.style.background = 'linear-gradient(90deg, #f39c12, #2ecc71)';
                } else {
                    consciousnessFill.style.background = 'linear-gradient(90deg, #2ecc71, #3498db, #9b59b6)';
                }
            },
            
            showConnectionPanel() {
                document.getElementById('connectionPanel').style.display = 'block';
            },
            
            hideConnectionPanel() {
                document.getElementById('connectionPanel').style.display = 'none';
            },
            
            showNotification(title, text) {
                const notification = document.getElementById('notification3d');
                document.getElementById('notificationTitle').textContent = title;
                document.getElementById('notificationText').textContent = text;
                
                notification.classList.add('active');
                
                setTimeout(() => {
                    notification.classList.remove('active');
                }, 3000);
            },
            
            // ==================== ابزارها ====================
            performAction() {
                // عمل پیش‌فرض (مثل ضربه زدن)
                const object = this.getObjectInFront();
                if (object) {
                    this.onObjectClick(object);
                } else {
                    // ایجاد موج انرژی
                    this.createEnergyWave();
                }
            },
            
            getObjectInFront() {
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(new THREE.Vector2(0, 0), this.camera);
                
                const objects = [...this.floatingWords, ...this.objects];
                const intersects = raycaster.intersectObjects(objects, true);
                
                return intersects.length > 0 ? intersects[0].object : null;
            },
            
            createEnergyWave() {
                const geometry = new THREE.SphereGeometry(0.5, 32, 32);
                const material = new THREE.MeshBasicMaterial({
                    color: 0x2ecc71,
                    transparent: true,
                    opacity: 0.8
                });
                
                const sphere = new THREE.Mesh(geometry, material);
                sphere.position.copy(this.camera.position);
                
                const direction = new THREE.Vector3(0, 0, -1);
                direction.applyQuaternion(this.camera.quaternion);
                
                this.scene.add(sphere);
                
                let distance = 0;
                const speed = 2;
                const maxDistance = 50;
                
                const animateWave = () => {
                    distance += speed;
                    sphere.position.add(direction.clone().multiplyScalar(speed));
                    sphere.material.opacity = 0.8 - (distance / maxDistance) * 0.8;
                    
                    if (distance < maxDistance) {
                        requestAnimationFrame(animateWave);
                    } else {
                        this.scene.remove(sphere);
                    }
                };
                
                animateWave();
            },
            
            interactWithObject() {
                const object = this.getObjectInFront();
                if (object) {
                    this.onObjectClick(object);
                } else {
                    this.showNotification('هیچ شیء قابل تعاملی پیدا نشد', 'به اشیاء نزدیک‌تر شوید');
                }
            },
            
            toggleInventory() {
                const inventory = document.getElementById('inventoryGrid').parentElement.parentElement;
                inventory.style.display = inventory.style.display === 'none' ? 'block' : 'none';
            },
            
            toggleCrouch() {
                this.camera.position.y -= this.state.isCrouching ? -2 : 2;
                this.state.isCrouching = !this.state.isCrouching;
            },
            
            toggleRun() {
                this.state.isRunning = !this.state.isRunning;
            },
            
            toggleFlashlight() {
                // ایجاد نور فلش‌لایت
                const flashlight = this.lights.find(l => l.userData?.flashlight);
                
                if (flashlight) {
                    this.scene.remove(flashlight);
                    this.lights = this.lights.filter(l => l !== flashlight);
                } else {
                    const light = new THREE.SpotLight(0xffffff, 2, 50, Math.PI / 6, 0.5, 2);
                    light.position.copy(this.camera.position);
                    light.target.position.copy(this.camera.position).add(new THREE.Vector3(0, 0, -10));
                    light.userData.flashlight = true;
                    
                    this.scene.add(light);
                    this.scene.add(light.target);
                    this.lights.push(light);
                    
                    // اتصال به دوربین
                    this.attachFlashlight(light);
                }
            },
            
            attachFlashlight(light) {
                const updateFlashlight = () => {
                    if (light.parent) {
                        light.position.copy(this.camera.position);
                        light.target.position.copy(this.camera.position)
                            .add(new THREE.Vector3(0, 0, -10).applyQuaternion(this.camera.quaternion));
                        requestAnimationFrame(updateFlashlight);
                    }
                };
                updateFlashlight();
            },
            
            showMap() {
                // ایجاد نقشه کوچک
                this.showNotification('نقشه جهان روانی', 'در حال توسعه...');
            },
            
            grabObject() {
                if (!this.state.selectedObject) {
                    const object = this.getObjectInFront();
                    if (object && object.userData.draggable) {
                        this.selectObject(object);
                    }
                } else {
                    this.dropObject();
                }
            },
            
            selectObject(object) {
                this.state.selectedObject = object;
                object.userData.selected = true;
                
                // هایلایت کردن شیء
                if (object.material) {
                    object.material.emissive = new THREE.Color(0xffff00);
                    object.material.emissiveIntensity = 0.5;
                }
                
                this.showNotification('شیء انتخاب شد', 'با کلید G آن را رها کنید');
            },
            
            dropObject() {
                if (this.state.selectedObject) {
                    const object = this.state.selectedObject;
                    object.userData.selected = false;
                    
                    if (object.material) {
                        object.material.emissive = new THREE.Color(0x000000);
                        object.material.emissiveIntensity = 0;
                    }
                    
                    this.state.selectedObject = null;
                }
            },
            
            dragObject(x, y) {
                if (!this.state.selectedObject) return;
                
                const mouse = new THREE.Vector2();
                const rect = this.renderer.domElement.getBoundingClientRect();
                
                mouse.x = ((x - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((y - rect.top) / rect.height) * 2 + 1;
                
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, this.camera);
                
                // پیدا کردن نقطه در عمق 10 متری
                const distance = 10;
                const direction = new THREE.Vector3(0, 0, -1);
                direction.applyQuaternion(this.camera.quaternion);
                const targetPosition = this.camera.position.clone().add(direction.multiplyScalar(distance));
                
                this.state.selectedObject.position.copy(targetPosition);
            },
            
            toggleMusic() {
                const musicIcon = document.getElementById('musicIcon');
                
                if (this.audio.ambient.paused) {
                    this.audio.ambient.play();
                    musicIcon.className = 'fas fa-pause';
                } else {
                    this.audio.ambient.pause();
                    musicIcon.className = 'fas fa-play';
                }
            },
            
            toggleVR() {
                // شبیه‌سازی حالت VR
                this.state.isVR = !this.state.isVR;
                
                if (this.state.isVR) {
                    this.renderer.xr.enabled = true;
                    this.camera.position.set(0, 1.6, 0); // ارتفاع چشم انسان
                    this.showNotification('حالت VR فعال شد', 'سر خود را برای نگاه کردن حرکت دهید');
                } else {
                    this.renderer.xr.enabled = false;
                    this.camera.position.set(0, 10, 20);
                    this.showNotification('حالت VR غیرفعال شد', 'به حالت عادی بازگشتید');
                }
            },
            
            // ==================== ابزارهای کمکی ====================
            pulseObject(object, color) {
                const originalColor = object.material.color.clone();
                const originalEmissive = object.material.emissive.clone();
                
                let intensity = 0;
                const pulse = () => {
                    intensity += 0.1;
                    object.material.emissive = new THREE.Color(color);
                    object.material.emissiveIntensity = Math.sin(intensity) * 0.8;
                    
                    if (intensity < Math.PI) {
                        requestAnimationFrame(pulse);
                    } else {
                        object.material.emissive.copy(originalEmissive);
                        object.material.emissiveIntensity = 0;
                    }
                };
                
                pulse();
            },
            
            checkInteractions() {
                // بررسی برخورد با اشیاء
                const objects = [...this.floatingWords, ...this.objects];
                const cameraPos = this.camera.position;
                
                objects.forEach(object => {
                    const distance = cameraPos.distanceTo(object.position);
                    if (distance < 5 && !object.userData.discovered) {
                        object.userData.discovered = true;
                        this.onObjectClick(object);
                    }
                });
            },
            
            playSound(soundName) {
                try {
                    const sound = this.audio[soundName];
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play();
                    }
                } catch (e) {
                    console.log('خطا در پخش صدا:', e);
                }
            },
            
            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
        };
        
        // شروع بازی
        document.addEventListener('DOMContentLoaded', () => {
            PsychedelicWorld.init();
        });
    </script>
</body>
</html>
