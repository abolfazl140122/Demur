<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Demur: دنیای سایه‌ها - بازی اکشن</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset و تنظیمات پایه */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #f0f0f0;
        }
        
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css');
        }
        
        /* صفحه بارگذاری */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 1s ease;
        }
        
        .loading-title {
            font-size: 3rem;
            color: #2ecc71;
            text-shadow: 0 0 20px rgba(46, 204, 113, 0.7);
            margin-bottom: 30px;
            letter-spacing: 3px;
        }
        
        .loading-bar {
            width: 400px;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .loading-progress {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #2ecc71, #1abc9c, #2ecc71);
            border-radius: 5px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .loading-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: loading-shine 2s infinite;
        }
        
        @keyframes loading-shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .loading-text {
            color: #aaa;
            font-size: 1.2rem;
            margin-top: 20px;
        }
        
        /* کانتینر اصلی بازی */
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            overflow: hidden;
        }
        
        /* Canvas بازی */
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* لایه UI روی بازی */
        #game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        /* هدر بازی */
        .game-header {
            position: absolute;
            top: 20px;
            right: 20px;
            left: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(10, 10, 10, 0.7);
            border-radius: 15px;
            border: 2px solid rgba(46, 204, 113, 0.3);
            backdrop-filter: blur(10px);
            pointer-events: all;
        }
        
        .game-title {
            font-size: 1.5rem;
            color: #2ecc71;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-container {
            display: flex;
            gap: 30px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            font-size: 1.1rem;
        }
        
        .stat-icon {
            color: #2ecc71;
            font-size: 1.3rem;
        }
        
        .stat-value {
            font-weight: bold;
            color: #fff;
        }
        
        /* نوار سلامتی */
        .health-bar-container {
            width: 200px;
            height: 20px;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .health-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
            border-radius: 8px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .health-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: health-pulse 3s infinite;
        }
        
        @keyframes health-pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }
        
        /* نوار انرژی */
        .energy-bar-container {
            width: 150px;
            height: 20px;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .energy-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        
        /* پنل کنترل */
        .control-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            left: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: all;
        }
        
        /* کنترل‌های حرکت */
        .movement-controls {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 10px;
            background: rgba(10, 10, 10, 0.7);
            padding: 20px;
            border-radius: 20px;
            border: 2px solid rgba(46, 204, 113, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .movement-btn {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid rgba(46, 204, 113, 0.5);
            color: #2ecc71;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .movement-btn:hover, .movement-btn.active {
            background: rgba(46, 204, 113, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.5);
        }
        
        .movement-btn:active {
            transform: scale(0.95);
        }
        
        /* دکمه‌های اکشن */
        .action-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(10, 10, 10, 0.7);
            padding: 20px;
            border-radius: 20px;
            border: 2px solid rgba(46, 204, 113, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .action-btn {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .action-btn::after {
            content: attr(data-key);
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .attack-btn {
            border-color: #e74c3c;
            color: #e74c3c;
        }
        
        .attack-btn:hover, .attack-btn.active {
            background: rgba(231, 76, 60, 0.2);
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.5);
        }
        
        .ability-btn {
            border-color: #9b59b6;
            color: #9b59b6;
        }
        
        .ability-btn:hover, .ability-btn.active {
            background: rgba(155, 89, 182, 0.2);
            box-shadow: 0 0 30px rgba(155, 89, 182, 0.5);
        }
        
        .jump-btn {
            border-color: #3498db;
            color: #3498db;
        }
        
        .jump-btn:hover, .jump-btn.active {
            background: rgba(52, 152, 219, 0.2);
            box-shadow: 0 0 30px rgba(52, 152, 219, 0.5);
        }
        
        /* پنل توانایی‌ها */
        .abilities-panel {
            position: absolute;
            top: 100px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(10, 10, 10, 0.7);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid rgba(46, 204, 113, 0.3);
            backdrop-filter: blur(10px);
            pointer-events: all;
        }
        
        .ability-item {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #aaa;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .ability-item.unlocked {
            border-color: #2ecc71;
            color: #2ecc71;
        }
        
        .ability-item:hover {
            transform: scale(1.1);
            background: rgba(46, 204, 113, 0.1);
        }
        
        .ability-cooldown {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(231, 76, 60, 0.7);
            border-radius: 0 0 8px 8px;
            text-align: center;
            color: white;
            font-size: 0.7rem;
            display: none;
        }
        
        /* منوی پاوز */
        .pause-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .pause-content {
            background: rgba(15, 15, 15, 0.95);
            border-radius: 20px;
            padding: 40px;
            border: 3px solid rgba(46, 204, 113, 0.3);
            width: 90%;
            max-width: 600px;
            text-align: center;
        }
        
        .pause-title {
            font-size: 2.5rem;
            color: #2ecc71;
            margin-bottom: 30px;
        }
        
        .pause-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .pause-btn {
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .pause-btn-primary {
            background: linear-gradient(90deg, #2ecc71, #1abc9c);
            color: #000;
        }
        
        .pause-btn-secondary {
            background: rgba(30, 30, 30, 0.7);
            border: 2px solid #2ecc71;
            color: #2ecc71;
        }
        
        .pause-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.3);
        }
        
        /* اعلان‌ها */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 10, 10, 0.95);
            padding: 15px 30px;
            border-radius: 10px;
            border: 2px solid #2ecc71;
            color: #2ecc71;
            font-size: 1rem;
            display: none;
            z-index: 2000;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            animation: slideDown 0.5s ease;
            pointer-events: none;
        }
        
        @keyframes slideDown {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
        
        /* صفحه مرگ */
        .death-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1500;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(20px);
        }
        
        .death-content {
            background: rgba(20, 0, 0, 0.9);
            border-radius: 20px;
            padding: 40px;
            border: 3px solid rgba(231, 76, 60, 0.5);
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 50px rgba(231, 76, 60, 0.3);
        }
        
        .death-title {
            font-size: 3rem;
            color: #e74c3c;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(231, 76, 60, 0.7);
        }
        
        .death-stats {
            background: rgba(30, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        /* صفحه سطح */
        .level-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1500;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(20px);
        }
        
        .level-content {
            background: rgba(15, 15, 15, 0.95);
            border-radius: 20px;
            padding: 40px;
            border: 3px solid rgba(46, 204, 113, 0.5);
            width: 90%;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 50px rgba(46, 204, 113, 0.3);
        }
        
        .level-title {
            font-size: 2.5rem;
            color: #2ecc71;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(46, 204, 113, 0.5);
        }
        
        /* اسکرول بار سفارشی */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #111;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #2ecc71;
            border-radius: 4px;
        }
        
        /* ریسپانسیو */
        @media (max-width: 992px) {
            .movement-controls {
                grid-template-columns: repeat(3, 50px);
                grid-template-rows: repeat(3, 50px);
            }
            
            .movement-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .action-btn {
                width: 70px;
                height: 70px;
                font-size: 1.5rem;
            }
            
            .game-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-container {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 768px) {
            .control-panel {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .abilities-panel {
                flex-direction: row;
                top: auto;
                bottom: 200px;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .loading-title {
                font-size: 2rem;
            }
            
            .loading-bar {
                width: 300px;
            }
        }
        
        /* انیمیشن‌های ویژه */
        @keyframes damage-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .damage-flash {
            animation: damage-flash 0.3s ease;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px rgba(46, 204, 113, 0.5); }
            50% { box-shadow: 0 0 20px rgba(46, 204, 113, 0.8); }
        }
        
        .glow-effect {
            animation: glow 2s infinite;
        }
        
        /* افکت‌های بصری */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }
        
        /* مینی مپ */
        .mini-map {
            position: absolute;
            bottom: 200px;
            right: 20px;
            width: 150px;
            height: 150px;
            background: rgba(10, 10, 10, 0.7);
            border-radius: 10px;
            border: 2px solid rgba(46, 204, 113, 0.3);
            backdrop-filter: blur(5px);
            overflow: hidden;
            pointer-events: all;
        }
        
        .map-content {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .map-player {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #2ecc71;
            border-radius: 50%;
            box-shadow: 0 0 10px #2ecc71;
        }
        
        .map-enemy {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #e74c3c;
            border-radius: 50%;
        }
        
        .map-objective {
            position: absolute;
            width: 5px;
            height: 5px;
            background: #3498db;
            border-radius: 50%;
            box-shadow: 0 0 5px #3498db;
        }
    </style>
</head>
<body>
    <!-- صفحه بارگذاری -->
    <div id="loading-screen">
        <div class="loading-title">DEMUR: دنیای سایه‌ها</div>
        <div class="loading-bar">
            <div class="loading-progress" id="loading-progress"></div>
        </div>
        <div class="loading-text" id="loading-text">در حال بارگذاری جهان مرموز...</div>
    </div>
    
    <!-- کانتینر اصلی بازی -->
    <div id="game-container">
        <!-- Canvas بازی -->
        <canvas id="game-canvas"></canvas>
        
        <!-- لایه UI روی بازی -->
        <div id="game-ui">
            <!-- هدر بازی -->
            <div class="game-header">
                <div class="game-title">
                    <i class="fas fa-dungeon"></i>
                    DEMUR: دنیای سایه‌ها
                </div>
                
                <div class="stats-container">
                    <div class="stat-item">
                        <i class="fas fa-heart stat-icon"></i>
                        <div class="health-bar-container">
                            <div class="health-bar" id="health-bar"></div>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <i class="fas fa-bolt stat-icon"></i>
                        <div class="energy-bar-container">
                            <div class="energy-bar" id="energy-bar"></div>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <i class="fas fa-skull stat-icon"></i>
                        <span>دشمنان: <span id="enemy-count">0</span></span>
                    </div>
                    
                    <div class="stat-item">
                        <i class="fas fa-trophy stat-icon"></i>
                        <span>امتیاز: <span id="score">0</span></span>
                    </div>
                    
                    <div class="stat-item">
                        <i class="fas fa-layer-group stat-icon"></i>
                        <span>سطح: <span id="level">1</span></span>
                    </div>
                </div>
            </div>
            
            <!-- پنل توانایی‌ها -->
            <div class="abilities-panel">
                <div class="ability-item unlocked" id="ability-1" data-ability="fireball">
                    <i class="fas fa-fire"></i>
                    <div class="ability-cooldown" id="cooldown-1"></div>
                </div>
                <div class="ability-item" id="ability-2" data-ability="shield">
                    <i class="fas fa-shield-alt"></i>
                    <div class="ability-cooldown" id="cooldown-2"></div>
                </div>
                <div class="ability-item" id="ability-3" data-ability="heal">
                    <i class="fas fa-heartbeat"></i>
                    <div class="ability-cooldown" id="cooldown-3"></div>
                </div>
                <div class="ability-item" id="ability-4" data-ability="teleport">
                    <i class="fas fa-sync-alt"></i>
                    <div class="ability-cooldown" id="cooldown-4"></div>
                </div>
            </div>
            
            <!-- مینی مپ -->
            <div class="mini-map">
                <div class="map-content" id="mini-map">
                    <div class="map-player" id="map-player"></div>
                </div>
            </div>
            
            <!-- پنل کنترل -->
            <div class="control-panel">
                <!-- کنترل‌های حرکت -->
                <div class="movement-controls">
                    <div class="movement-btn" id="btn-up-left">
                        <i class="fas fa-arrow-up-left"></i>
                    </div>
                    <div class="movement-btn" id="btn-up">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="movement-btn" id="btn-up-right">
                        <i class="fas fa-arrow-up-right"></i>
                    </div>
                    <div class="movement-btn" id="btn-left">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="movement-btn" id="btn-center">
                        <i class="fas fa-crosshairs"></i>
                    </div>
                    <div class="movement-btn" id="btn-right">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                    <div class="movement-btn" id="btn-down-left">
                        <i class="fas fa-arrow-down-left"></i>
                    </div>
                    <div class="movement-btn" id="btn-down">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="movement-btn" id="btn-down-right">
                        <i class="fas fa-arrow-down-right"></i>
                    </div>
                </div>
                
                <!-- دکمه‌های اکشن -->
                <div class="action-controls">
                    <button class="action-btn attack-btn" id="attack-btn" data-key="Space">
                        <i class="fas fa-fist-raised"></i>
                    </button>
                    <button class="action-btn ability-btn" id="ability-btn" data-key="Q">
                        <i class="fas fa-magic"></i>
                    </button>
                    <button class="action-btn jump-btn" id="jump-btn" data-key="W">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- منوی پاوز -->
    <div class="pause-menu" id="pause-menu">
        <div class="pause-content">
            <h2 class="pause-title">
                <i class="fas fa-pause"></i>
                بازی متوقف شد
            </h2>
            <div class="pause-options">
                <button class="pause-btn pause-btn-primary" id="resume-btn">
                    <i class="fas fa-play"></i>
                    ادامه بازی
                </button>
                <button class="pause-btn pause-btn-secondary" id="restart-btn">
                    <i class="fas fa-redo"></i>
                    شروع مجدد
                </button>
                <button class="pause-btn pause-btn-secondary" id="sound-toggle-btn">
                    <i class="fas fa-volume-up"></i>
                    صدا: روشن
                </button>
                <button class="pause-btn pause-btn-secondary" id="main-menu-btn">
                    <i class="fas fa-home"></i>
                    خروج به منو
                </button>
            </div>
        </div>
    </div>
    
    <!-- صفحه مرگ -->
    <div class="death-screen" id="death-screen">
        <div class="death-content">
            <h2 class="death-title">
                <i class="fas fa-skull-crossbones"></i>
                شما شکست خوردید!
            </h2>
            <div class="death-stats">
                <p>سطح: <span id="death-level">1</span></p>
                <p>امتیاز: <span id="death-score">0</span></p>
                <p>دشمنان نابود شده: <span id="death-enemies">0</span></p>
                <p>زمان بازی: <span id="death-time">0:00</span></p>
            </div>
            <div class="pause-options">
                <button class="pause-btn pause-btn-primary" id="retry-btn">
                    <i class="fas fa-redo"></i>
                    تلاش مجدد
                </button>
                <button class="pause-btn pause-btn-secondary" id="death-menu-btn">
                    <i class="fas fa-home"></i>
                    بازگشت به منو
                </button>
            </div>
        </div>
    </div>
    
    <!-- صفحه سطح -->
    <div class="level-screen" id="level-screen">
        <div class="level-content">
            <h2 class="level-title" id="level-title">سطح 1: جنگل تاریک</h2>
            <div class="death-stats">
                <p>مأموریت: <span id="level-mission">10 دشمن را نابود کنید</span></p>
                <p>اهداف: <span id="level-objectives">0/10 دشمنان نابود شده</span></p>
                <p>پاداش: <span id="level-reward">قدرت آتش</span></p>
            </div>
            <div class="pause-options">
                <button class="pause-btn pause-btn-primary" id="start-level-btn">
                    <i class="fas fa-play"></i>
                    شروع مأموریت
                </button>
            </div>
        </div>
    </div>
    
    <!-- اعلان -->
    <div class="notification" id="notification"></div>
    
    <!-- صداها -->
    <audio id="background-music" loop preload="auto">
        <source src="https://raw.githubusercontent.com/abolfazl140122/Demur/018d52042cb43d84da7c17daf49f35da735bd3e9/%D9%85%D9%88%D8%B2%DB%8C%DA%A9%20%D8%A8%D8%AF%20%DA%AF%D8%B1%D8%A7%D9%86%D8%AF%20%D8%B5%D9%81%D9%87%20%D9%84%D9%88%D8%AF%DB%8C%D9%86%DA%AF%20%D8%A7%DB%8C%D8%B3%D8%AA%D8%A7%D8%AF%D9%87.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="attack-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-sword-slash-2768.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="damage-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-man-pain-scream-380.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="enemy-death-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-creature-cry-of-hurt-2208.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="ability-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-magic-spell-illusion-312.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="level-up-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="button-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ==================== متغیرهای اصلی بازی ====================
        const Game = {
            // وضعیت بازی
            state: {
                loaded: false,
                running: false,
                paused: false,
                playerAlive: true,
                currentLevel: 1,
                score: 0,
                enemiesKilled: 0,
                startTime: null,
                gameTime: 0,
                musicEnabled: true,
                soundEnabled: true
            },
            
            // تنظیمات بازی
            config: {
                canvasWidth: 0,
                canvasHeight: 0,
                gravity: 0.5,
                friction: 0.9,
                playerSpeed: 5,
                jumpForce: -12,
                enemySpawnRate: 2000, // میلی‌ثانیه
                maxEnemies: 15
            },
            
            // اشیاء بازی
            player: null,
            enemies: [],
            particles: [],
            abilities: [],
            platforms: [],
            items: [],
            
            // کنترل‌ها
            keys: {},
            mouse: { x: 0, y: 0 },
            
            // منابع
            images: {},
            sounds: {},
            
            // زمان‌سنج‌ها
            lastTime: 0,
            deltaTime: 0,
            enemySpawnTimer: 0,
            particleTimer: 0,
            levelComplete: false
        };
        
        // ==================== کلاس‌های بازی ====================
        class Player {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 40;
                this.height = 60;
                this.velocityX = 0;
                this.velocityY = 0;
                this.onGround = false;
                this.facingRight = true;
                
                // آمار
                this.health = 100;
                this.maxHealth = 100;
                this.energy = 100;
                this.maxEnergy = 100;
                this.energyRegen = 0.5;
                
                // توانایی‌ها
                this.abilities = {
                    fireball: { unlocked: true, cooldown: 0, maxCooldown: 3000 },
                    shield: { unlocked: false, cooldown: 0, maxCooldown: 10000 },
                    heal: { unlocked: false, cooldown: 0, maxCooldown: 15000 },
                    teleport: { unlocked: false, cooldown: 0, maxCooldown: 8000 }
                };
                
                // حالت‌ها
                this.attacking = false;
                this.attackCooldown = 0;
                this.invulnerable = false;
                this.invulnerableTimer = 0;
                this.shieldActive = false;
                this.shieldTimer = 0;
                
                // انیمیشن
                this.animationFrame = 0;
                this.animationTimer = 0;
            }
            
            update(deltaTime) {
                // حرکت افقی
                let moveX = 0;
                if (Game.keys['ArrowRight'] || Game.keys['d'] || Game.keys['D']) {
                    moveX += 1;
                    this.facingRight = true;
                }
                if (Game.keys['ArrowLeft'] || Game.keys['a'] || Game.keys['A']) {
                    moveX -= 1;
                    this.facingRight = false;
                }
                
                this.velocityX = moveX * Game.config.playerSpeed;
                
                // پرش
                if ((Game.keys['ArrowUp'] || Game.keys['w'] || Game.keys['W'] || Game.keys[' ']) && this.onGround) {
                    this.velocityY = Game.config.jumpForce;
                    this.onGround = false;
                    playSound('button');
                }
                
                // اعمال گرانش
                this.velocityY += Game.config.gravity;
                
                // اعمال اصطکاک
                this.velocityX *= Game.config.friction;
                
                // به‌روزرسانی موقعیت
                this.x += this.velocityX;
                this.y += this.velocityY;
                
                // مرزهای بازی
                if (this.x < 0) this.x = 0;
                if (this.x > Game.config.canvasWidth - this.width) this.x = Game.config.canvasWidth - this.width;
                if (this.y > Game.config.canvasHeight - this.height) {
                    this.y = Game.config.canvasHeight - this.height;
                    this.velocityY = 0;
                    this.onGround = true;
                }
                
                // بازسازی انرژی
                if (this.energy < this.maxEnergy) {
                    this.energy += this.energyRegen * (deltaTime / 16);
                    if (this.energy > this.maxEnergy) this.energy = this.maxEnergy;
                    updateEnergyBar();
                }
                
                // به‌روزرسانی کولدون توانایی‌ها
                for (const ability in this.abilities) {
                    if (this.abilities[ability].cooldown > 0) {
                        this.abilities[ability].cooldown -= deltaTime;
                        updateAbilityCooldown(ability, this.abilities[ability].cooldown, this.abilities[ability].maxCooldown);
                    }
                }
                
                // به‌روزرسانی کولدون حمله
                if (this.attackCooldown > 0) {
                    this.attackCooldown -= deltaTime;
                }
                
                // به‌روزرسانی آسیب‌ناپذیری
                if (this.invulnerable) {
                    this.invulnerableTimer -= deltaTime;
                    if (this.invulnerableTimer <= 0) {
                        this.invulnerable = false;
                    }
                }
                
                // به‌روزرسانی سپر
                if (this.shieldActive) {
                    this.shieldTimer -= deltaTime;
                    if (this.shieldTimer <= 0) {
                        this.shieldActive = false;
                    }
                }
                
                // انیمیشن
                this.animationTimer += deltaTime;
                if (this.animationTimer > 100) {
                    this.animationFrame = (this.animationFrame + 1) % 4;
                    this.animationTimer = 0;
                }
                
                // به‌روزرسانی موقعیت در مینی‌مپ
                updateMiniMap();
            }
            
            draw(ctx) {
                // رنگ بازیکن با توجه به حالت
                let color = '#2ecc71';
                if (this.invulnerable && Math.floor(Date.now() / 100) % 2 === 0) {
                    color = 'rgba(46, 204, 113, 0.5)';
                }
                if (this.shieldActive) {
                    color = '#3498db';
                }
                
                // کشیدن بازیکن
                ctx.save();
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
                if (!this.facingRight) {
                    ctx.scale(-1, 1);
                }
                
                // بدنه بازیکن
                ctx.fillStyle = color;
                ctx.fillRect(-this.width / 2, -this.height / 2, this.width, this.height);
                
                // جزئیات بازیکن
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(-this.width / 2 + 5, -this.height / 2 + 5, this.width - 10, 15);
                
                // چشم‌ها
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(-10, -10, 6, 6);
                ctx.fillRect(4, -10, 6, 6);
                
                // سلاح
                if (this.attacking) {
                    ctx.fillStyle = '#e74c3c';
                    ctx.fillRect(this.width / 2 - 5, -5, 30, 10);
                }
                
                ctx.restore();
                
                // کشیدن سپر اگر فعال باشد
                if (this.shieldActive) {
                    ctx.save();
                    ctx.strokeStyle = 'rgba(52, 152, 219, 0.7)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width / 2, this.y + this.height / 2, this.width + 10, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();
                }
            }
            
            takeDamage(amount) {
                if (this.invulnerable || this.shieldActive) return;
                
                this.health -= amount;
                if (this.health < 0) this.health = 0;
                
                this.invulnerable = true;
                this.invulnerableTimer = 1000;
                
                playSound('damage');
                createParticles(this.x + this.width / 2, this.y + this.height / 2, 10, '#e74c3c');
                
                updateHealthBar();
                
                if (this.health <= 0) {
                    this.die();
                }
            }
            
            die() {
                Game.state.playerAlive = false;
                createParticles(this.x + this.width / 2, this.y + this.height / 2, 30, '#e74c3c');
                showDeathScreen();
            }
            
            attack() {
                if (this.attackCooldown > 0) return;
                
                this.attacking = true;
                this.attackCooldown = 300;
                
                playSound('attack');
                
                // ایجاد منطقه حمله
                const attackX = this.facingRight ? this.x + this.width : this.x - 50;
                const attackY = this.y + this.height / 2 - 25;
                const attackWidth = 50;
                const attackHeight = 50;
                
                // بررسی برخورد با دشمنان
                for (let i = Game.enemies.length - 1; i >= 0; i--) {
                    const enemy = Game.enemies[i];
                    if (checkCollision(attackX, attackY, attackWidth, attackHeight, enemy.x, enemy.y, enemy.width, enemy.height)) {
                        enemy.takeDamage(25);
                        Game.state.score += 10;
                        Game.state.enemiesKilled++;
                        updateScore();
                        updateEnemyCount();
                    }
                }
                
                // ایجاد ذرات حمله
                createParticles(attackX + attackWidth / 2, attackY + attackHeight / 2, 8, '#f39c12');
                
                setTimeout(() => {
                    this.attacking = false;
                }, 200);
            }
            
            useAbility(abilityName) {
                const ability = this.abilities[abilityName];
                if (!ability.unlocked || ability.cooldown > 0 || this.energy < 20) return;
                
                playSound('ability');
                this.energy -= 20;
                updateEnergyBar();
                ability.cooldown = ability.maxCooldown;
                
                switch(abilityName) {
                    case 'fireball':
                        createFireball(this.x + this.width / 2, this.y + this.height / 2, this.facingRight ? 1 : -1);
                        break;
                    case 'shield':
                        this.shieldActive = true;
                        this.shieldTimer = 5000;
                        break;
                    case 'heal':
                        this.health += 30;
                        if (this.health > this.maxHealth) this.health = this.maxHealth;
                        updateHealthBar();
                        createParticles(this.x + this.width / 2, this.y + this.height / 2, 15, '#2ecc71');
                        break;
                    case 'teleport':
                        this.x = Math.random() * (Game.config.canvasWidth - this.width);
                        this.y = Math.random() * (Game.config.canvasHeight - this.height);
                        createParticles(this.x + this.width / 2, this.y + this.height / 2, 20, '#9b59b6');
                        break;
                }
                
                updateAbilityCooldown(abilityName, ability.cooldown, ability.maxCooldown);
            }
        }
        
        class Enemy {
            constructor(x, y, type = 'normal') {
                this.x = x;
                this.y = y;
                this.type = type;
                this.width = 40;
                this.height = 40;
                this.velocityX = 0;
                this.velocityY = 0;
                
                // نوع‌های مختلف دشمن
                switch(type) {
                    case 'normal':
                        this.color = '#e74c3c';
                        this.speed = 2;
                        this.health = 50;
                        this.damage = 10;
                        break;
                    case 'fast':
                        this.color = '#f39c12';
                        this.speed = 4;
                        this.health = 30;
                        this.damage = 8;
                        this.width = 30;
                        this.height = 30;
                        break;
                    case 'tank':
                        this.color = '#7f8c8d';
                        this.speed = 1;
                        this.health = 150;
                        this.damage = 20;
                        this.width = 60;
                        this.height = 60;
                        break;
                    case 'ranged':
                        this.color = '#9b59b6';
                        this.speed = 1.5;
                        this.health = 40;
                        this.damage = 15;
                        this.attackRange = 200;
                        this.attackCooldown = 0;
                        break;
                }
                
                this.maxHealth = this.health;
                this.active = true;
                this.animationFrame = 0;
            }
            
            update(deltaTime) {
                // دنبال کردن بازیکن
                if (Game.player) {
                    const dx = Game.player.x - this.x;
                    const dy = Game.player.y - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 0) {
                        this.velocityX = (dx / distance) * this.speed;
                        this.velocityY = (dy / distance) * this.speed;
                    }
                    
                    // حمله از راه دور برای دشمن ranged
                    if (this.type === 'ranged') {
                        if (this.attackCooldown > 0) {
                            this.attackCooldown -= deltaTime;
                        } else if (distance < this.attackRange) {
                            this.rangedAttack();
                            this.attackCooldown = 2000;
                        }
                    }
                }
                
                // به‌روزرسانی موقعیت
                this.x += this.velocityX;
                this.y += this.velocityY;
                
                // برخورد با بازیکن
                if (Game.player && checkCollision(this.x, this.y, this.width, this.height, 
                    Game.player.x, Game.player.y, Game.player.width, Game.player.height)) {
                    Game.player.takeDamage(this.damage);
                }
                
                // انیمیشن
                this.animationFrame = (this.animationFrame + 0.1) % 4;
            }
            
            draw(ctx) {
                // کشیدن دشمن
                ctx.save();
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // جزئیات دشمن
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(this.x + 5, this.y + 5, this.width - 10, 8);
                
                // نوار سلامتی
                if (this.health < this.maxHealth) {
                    const healthWidth = (this.health / this.maxHealth) * (this.width - 10);
                    ctx.fillStyle = '#2ecc71';
                    ctx.fillRect(this.x + 5, this.y + 5, healthWidth, 5);
                }
                
                // چشم‌ها
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(this.x + 10, this.y + 15, 6, 6);
                ctx.fillRect(this.x + this.width - 16, this.y + 15, 6, 6);
                
                ctx.restore();
            }
            
            takeDamage(amount) {
                this.health -= amount;
                createParticles(this.x + this.width / 2, this.y + this.height / 2, 5, this.color);
                
                if (this.health <= 0) {
                    this.die();
                }
            }
            
            die() {
                this.active = false;
                Game.state.score += this.type === 'normal' ? 20 : 
                                   this.type === 'fast' ? 30 : 
                                   this.type === 'tank' ? 50 : 40;
                updateScore();
                createParticles(this.x + this.width / 2, this.y + this.height / 2, 15, this.color);
                playSound('enemy-death');
            }
            
            rangedAttack() {
                if (!Game.player) return;
                
                const dx = Game.player.x - this.x;
                const dy = Game.player.y - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const velocityX = (dx / distance) * 5;
                const velocityY = (dy / distance) * 5;
                
                Game.abilities.push({
                    x: this.x + this.width / 2,
                    y: this.y + this.height / 2,
                    width: 10,
                    height: 10,
                    velocityX: velocityX,
                    velocityY: velocityY,
                    color: '#9b59b6',
                    damage: 15,
                    enemyProjectile: true
                });
            }
        }
        
        // ==================== توابع کمکی ====================
        function checkCollision(x1, y1, w1, h1, x2, y2, w2, h2) {
            return x1 < x2 + w2 && 
                   x1 + w1 > x2 && 
                   y1 < y2 + h2 && 
                   y1 + h1 > y2;
        }
        
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                Game.particles.push({
                    x: x,
                    y: y,
                    velocityX: (Math.random() - 0.5) * 10,
                    velocityY: (Math.random() - 0.5) * 10,
                    size: Math.random() * 5 + 2,
                    color: color,
                    life: 1,
                    decay: 0.02 + Math.random() * 0.03
                });
            }
        }
        
        function createFireball(x, y, direction) {
            Game.abilities.push({
                x: x,
                y: y,
                width: 20,
                height: 20,
                velocityX: direction * 8,
                velocityY: 0,
                color: '#f39c12',
                damage: 40,
                type: 'fireball'
            });
        }
        
        function playSound(soundName) {
            if (!Game.state.soundEnabled) return;
            
            try {
                const sound = Game.sounds[soundName];
                if (sound) {
                    sound.currentTime = 0;
                    sound.play();
                }
            } catch (e) {
                console.log("خطا در پخش صدا");
            }
        }
        
        function updateHealthBar() {
            const healthPercent = (Game.player.health / Game.player.maxHealth) * 100;
            document.getElementById('health-bar').style.width = `${healthPercent}%`;
        }
        
        function updateEnergyBar() {
            const energyPercent = (Game.player.energy / Game.player.maxEnergy) * 100;
            document.getElementById('energy-bar').style.width = `${energyPercent}%`;
        }
        
        function updateScore() {
            document.getElementById('score').textContent = Game.state.score;
        }
        
        function updateEnemyCount() {
            document.getElementById('enemy-count').textContent = Game.enemies.length;
            
            // بررسی تکمیل سطح
            if (Game.state.currentLevel === 1 && Game.state.enemiesKilled >= 10) {
                completeLevel();
            }
        }
        
        function updateAbilityCooldown(abilityName, cooldown, maxCooldown) {
            const abilityId = `cooldown-${abilityName === 'fireball' ? 1 : 
                              abilityName === 'shield' ? 2 : 
                              abilityName === 'heal' ? 3 : 4}`;
            
            const cooldownElement = document.getElementById(abilityId);
            if (cooldown > 0) {
                const percent = (cooldown / maxCooldown) * 100;
                cooldownElement.style.height = `${percent}%`;
                cooldownElement.textContent = `${Math.ceil(cooldown / 1000)}s`;
                cooldownElement.style.display = 'block';
            } else {
                cooldownElement.style.display = 'none';
            }
        }
        
        function updateMiniMap() {
            if (!Game.player) return;
            
            const map = document.getElementById('mini-map');
            const playerDot = document.getElementById('map-player');
            
            // موقعیت بازیکن در مینی‌مپ
            const playerXPercent = (Game.player.x / Game.config.canvasWidth) * 100;
            const playerYPercent = (Game.player.y / Game.config.canvasHeight) * 100;
            
            playerDot.style.left = `${playerXPercent}%`;
            playerDot.style.top = `${playerYPercent}%`;
            
            // حذف دشمنان قدیمی
            const oldEnemies = map.querySelectorAll('.map-enemy');
            oldEnemies.forEach(enemy => enemy.remove());
            
            // اضافه کردن دشمنان جدید
            Game.enemies.forEach(enemy => {
                if (enemy.active) {
                    const enemyDot = document.createElement('div');
                    enemyDot.className = 'map-enemy';
                    
                    const enemyXPercent = (enemy.x / Game.config.canvasWidth) * 100;
                    const enemyYPercent = (enemy.y / Game.config.canvasHeight) * 100;
                    
                    enemyDot.style.left = `${enemyXPercent}%`;
                    enemyDot.style.top = `${enemyYPercent}%`;
                    
                    map.appendChild(enemyDot);
                }
            });
        }
        
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.style.display = 'none';
                    notification.style.opacity = '1';
                }, 500);
            }, duration);
        }
        
        function showDeathScreen() {
            document.getElementById('death-level').textContent = Game.state.currentLevel;
            document.getElementById('death-score').textContent = Game.state.score;
            document.getElementById('death-enemies').textContent = Game.state.enemiesKilled;
            
            const minutes = Math.floor(Game.state.gameTime / 60000);
            const seconds = Math.floor((Game.state.gameTime % 60000) / 1000);
            document.getElementById('death-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('death-screen').style.display = 'flex';
        }
        
        function completeLevel() {
            if (Game.levelComplete) return;
            
            Game.levelComplete = true;
            Game.state.running = false;
            
            // باز کردن توانایی جدید
            if (Game.state.currentLevel === 1) {
                Game.player.abilities.shield.unlocked = true;
                document.getElementById('ability-2').classList.add('unlocked');
            }
            
            // نمایش صفحه سطح
            document.getElementById('level-title').textContent = `سطح ${Game.state.currentLevel + 1}: معبد فراموش شده`;
            document.getElementById('level-mission').textContent = 'سنگ افسانه‌ای را پیدا کنید';
            document.getElementById('level-objectives').textContent = 'ماموریت تکمیل شد!';
            document.getElementById('level-reward').textContent = 'توانایی سپر';
            
            document.getElementById('level-screen').style.display = 'flex';
            
            playSound('level-up');
            showNotification(`سطح ${Game.state.currentLevel} تکمیل شد!`, 5000);
        }
        
        function startNextLevel() {
            Game.state.currentLevel++;
            Game.levelComplete = false;
            Game.state.running = true;
            
            document.getElementById('level').textContent = Game.state.currentLevel;
            document.getElementById('level-screen').style.display = 'none';
            
            // پاک کردن دشمنان قدیمی
            Game.enemies = [];
            
            // ریست بازیکن
            Game.player.health = Game.player.maxHealth;
            Game.player.energy = Game.player.maxEnergy;
            Game.player.x = Game.config.canvasWidth / 2;
            Game.player.y = Game.config.canvasHeight / 2;
            
            updateHealthBar();
            updateEnergyBar();
            updateEnemyCount();
            
            showNotification(`سطح ${Game.state.currentLevel} شروع شد!`, 3000);
        }
        
        // ==================== حلقه بازی ====================
        function gameLoop(timestamp) {
            if (!Game.lastTime) Game.lastTime = timestamp;
            Game.deltaTime = timestamp - Game.lastTime;
            Game.lastTime = timestamp;
            
            // به‌روزرسانی زمان بازی
            if (Game.state.running && Game.state.playerAlive) {
                Game.state.gameTime += Game.deltaTime;
            }
            
            // به‌روزرسانی اشیاء بازی
            if (Game.state.running && !Game.state.paused && Game.state.playerAlive) {
                // به‌روزرسانی بازیکن
                if (Game.player) {
                    Game.player.update(Game.deltaTime);
                }
                
                // به‌روزرسانی دشمنان
                for (let i = Game.enemies.length - 1; i >= 0; i--) {
                    const enemy = Game.enemies[i];
                    enemy.update(Game.deltaTime);
                    
                    if (!enemy.active) {
                        Game.enemies.splice(i, 1);
                    }
                }
                
                // به‌روزرسانی توانایی‌ها
                for (let i = Game.abilities.length - 1; i >= 0; i--) {
                    const ability = Game.abilities[i];
                    ability.x += ability.velocityX;
                    ability.y += ability.velocityY;
                    
                    // بررسی برخورد با دشمنان
                    if (!ability.enemyProjectile) {
                        for (let j = Game.enemies.length - 1; j >= 0; j--) {
                            const enemy = Game.enemies[j];
                            if (checkCollision(ability.x, ability.y, ability.width, ability.height, 
                                enemy.x, enemy.y, enemy.width, enemy.height)) {
                                enemy.takeDamage(ability.damage);
                                Game.abilities.splice(i, 1);
                                break;
                            }
                        }
                    }
                    
                    // بررسی برخورد با بازیکن
                    if (ability.enemyProjectile && Game.player) {
                        if (checkCollision(ability.x, ability.y, ability.width, ability.height, 
                            Game.player.x, Game.player.y, Game.player.width, Game.player.height)) {
                            Game.player.takeDamage(ability.damage);
                            Game.abilities.splice(i, 1);
                        }
                    }
                    
                    // حذف اگر خارج از صفحه باشد
                    if (ability.x < -100 || ability.x > Game.config.canvasWidth + 100 || 
                        ability.y < -100 || ability.y > Game.config.canvasHeight + 100) {
                        Game.abilities.splice(i, 1);
                    }
                }
                
                // به‌روزرسانی ذرات
                for (let i = Game.particles.length - 1; i >= 0; i--) {
                    const particle = Game.particles[i];
                    particle.x += particle.velocityX;
                    particle.y += particle.velocityY;
                    particle.velocityY += 0.1; // گرانش
                    particle.life -= particle.decay;
                    
                    if (particle.life <= 0) {
                        Game.particles.splice(i, 1);
                    }
                }
                
                // تولید دشمن جدید
                if (Game.enemies.length < Game.config.maxEnemies) {
                    Game.enemySpawnTimer += Game.deltaTime;
                    if (Game.enemySpawnTimer > Game.config.enemySpawnRate) {
                        spawnEnemy();
                        Game.enemySpawnTimer = 0;
                    }
                }
            }
            
            // رندر بازی
            renderGame();
            
            // ادامه حلقه بازی
            if (Game.state.loaded) {
                requestAnimationFrame(gameLoop);
            }
        }
        
        function renderGame() {
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            
            // پاک کردن Canvas
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // کشیدن پس‌زمینه (گرادیان تاریک)
            const gradient = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, 0,
                canvas.width / 2, canvas.height / 2, canvas.width / 2
            );
            gradient.addColorStop(0, 'rgba(20, 20, 20, 0.8)');
            gradient.addColorStop(1, 'rgba(10, 10, 10, 1)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // کشیدن الگوی توری
            ctx.strokeStyle = 'rgba(46, 204, 113, 0.05)';
            ctx.lineWidth = 1;
            
            // خطوط عمودی
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // خطوط افقی
            for (let y = 0; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // کشیدن اشیاء بازی
            if (Game.state.running) {
                // کشیدن توانایی‌ها
                Game.abilities.forEach(ability => {
                    ctx.fillStyle = ability.color;
                    ctx.fillRect(ability.x - ability.width / 2, ability.y - ability.height / 2, ability.width, ability.height);
                    
                    // افکت گلوی برای fireball
                    if (ability.type === 'fireball') {
                        ctx.fillStyle = 'rgba(243, 156, 18, 0.5)';
                        ctx.beginPath();
                        ctx.arc(ability.x, ability.y, ability.width * 1.5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
                
                // کشیدن دشمنان
                Game.enemies.forEach(enemy => {
                    enemy.draw(ctx);
                });
                
                // کشیدن بازیکن
                if (Game.player) {
                    Game.player.draw(ctx);
                }
                
                // کشیدن ذرات
                Game.particles.forEach(particle => {
                    ctx.globalAlpha = particle.life;
                    ctx.fillStyle = particle.color;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalAlpha = 1;
                });
            }
            
            // کشیدن افکت‌های ویژه اگر بازی متوقف شده باشد
            if (!Game.state.running && !Game.state.paused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#2ecc71';
                ctx.font = '3rem Vazirmatn';
                ctx.textAlign = 'center';
                ctx.fillText('DEMUR', canvas.width / 2, canvas.height / 2 - 50);
                
                ctx.fillStyle = '#aaa';
                ctx.font = '1.5rem Vazirmatn';
                ctx.fillText('برای شروع بازی کلیک کنید', canvas.width / 2, canvas.height / 2 + 30);
            }
        }
        
        function spawnEnemy() {
            const types = ['normal', 'fast', 'tank', 'ranged'];
            const typeWeights = [0.5, 0.3, 0.15, 0.05];
            
            let random = Math.random();
            let typeIndex = 0;
            let cumulativeWeight = 0;
            
            for (let i = 0; i < typeWeights.length; i++) {
                cumulativeWeight += typeWeights[i];
                if (random <= cumulativeWeight) {
                    typeIndex = i;
                    break;
                }
            }
            
            const type = types[typeIndex];
            
            // ایجاد دشمن در موقعیت تصادفی لبه صفحه
            const side = Math.floor(Math.random() * 4);
            let x, y;
            
            switch(side) {
                case 0: // بالا
                    x = Math.random() * Game.config.canvasWidth;
                    y = -50;
                    break;
                case 1: // راست
                    x = Game.config.canvasWidth + 50;
                    y = Math.random() * Game.config.canvasHeight;
                    break;
                case 2: // پایین
                    x = Math.random() * Game.config.canvasWidth;
                    y = Game.config.canvasHeight + 50;
                    break;
                case 3: // چپ
                    x = -50;
                    y = Math.random() * Game.config.canvasHeight;
                    break;
            }
            
            Game.enemies.push(new Enemy(x, y, type));
            updateEnemyCount();
        }
        
        // ==================== مدیریت رویدادها ====================
        function initControls() {
            // کنترل‌های کیبورد
            document.addEventListener('keydown', (e) => {
                Game.keys[e.key] = true;
                
                // پاوز/ادامه بازی با کلید Escape
                if (e.key === 'Escape') {
                    togglePause();
                }
                
                // حمله با Space
                if (e.key === ' ' && Game.state.running && Game.player) {
                    Game.player.attack();
                    document.getElementById('attack-btn').classList.add('active');
                    setTimeout(() => {
                        document.getElementById('attack-btn').classList.remove('active');
                    }, 200);
                }
                
                // توانایی با Q
                if (e.key === 'q' && Game.state.running && Game.player) {
                    Game.player.useAbility('fireball');
                    document.getElementById('ability-btn').classList.add('active');
                    setTimeout(() => {
                        document.getElementById('ability-btn').classList.remove('active');
                    }, 200);
                }
                
                // پرش با W
                if (e.key === 'w' && Game.state.running && Game.player) {
                    document.getElementById('jump-btn').classList.add('active');
                    setTimeout(() => {
                        document.getElementById('jump-btn').classList.remove('active');
                    }, 200);
                }
            });
            
            document.addEventListener('keyup', (e) => {
                Game.keys[e.key] = false;
            });
            
            // کنترل‌های لمسی برای موبایل
            const movementButtons = document.querySelectorAll('.movement-btn');
            movementButtons.forEach(btn => {
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const id = btn.id;
                    
                    if (id === 'btn-up') Game.keys['ArrowUp'] = true;
                    if (id === 'btn-down') Game.keys['ArrowDown'] = true;
                    if (id === 'btn-left') Game.keys['ArrowLeft'] = true;
                    if (id === 'btn-right') Game.keys['ArrowRight'] = true;
                    if (id === 'btn-up-left') { Game.keys['ArrowUp'] = true; Game.keys['ArrowLeft'] = true; }
                    if (id === 'btn-up-right') { Game.keys['ArrowUp'] = true; Game.keys['ArrowRight'] = true; }
                    if (id === 'btn-down-left') { Game.keys['ArrowDown'] = true; Game.keys['ArrowLeft'] = true; }
                    if (id === 'btn-down-right') { Game.keys['ArrowDown'] = true; Game.keys['ArrowRight'] = true; }
                    
                    btn.classList.add('active');
                });
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const id = btn.id;
                    
                    if (id === 'btn-up') Game.keys['ArrowUp'] = false;
                    if (id === 'btn-down') Game.keys['ArrowDown'] = false;
                    if (id === 'btn-left') Game.keys['ArrowLeft'] = false;
                    if (id === 'btn-right') Game.keys['ArrowRight'] = false;
                    if (id === 'btn-up-left') { Game.keys['ArrowUp'] = false; Game.keys['ArrowLeft'] = false; }
                    if (id === 'btn-up-right') { Game.keys['ArrowUp'] = false; Game.keys['ArrowRight'] = false; }
                    if (id === 'btn-down-left') { Game.keys['ArrowDown'] = false; Game.keys['ArrowLeft'] = false; }
                    if (id === 'btn-down-right') { Game.keys['ArrowDown'] = false; Game.keys['ArrowRight'] = false; }
                    
                    btn.classList.remove('active');
                });
            });
            
            // دکمه‌های اکشن
            document.getElementById('attack-btn').addEventListener('click', () => {
                if (Game.state.running && Game.player) {
                    Game.player.attack();
                    playSound('button');
                }
            });
            
            document.getElementById('ability-btn').addEventListener('click', () => {
                if (Game.state.running && Game.player) {
                    Game.player.useAbility('fireball');
                    playSound('button');
                }
            });
            
            document.getElementById('jump-btn').addEventListener('click', () => {
                if (Game.state.running && Game.player) {
                    playSound('button');
                }
            });
            
            // توانایی‌ها
            document.querySelectorAll('.ability-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (!Game.state.running || !Game.player) return;
                    
                    const ability = item.dataset.ability;
                    if (item.classList.contains('unlocked')) {
                        Game.player.useAbility(ability);
                        playSound('button');
                    }
                });
            });
            
            // منوی پاوز
            document.getElementById('resume-btn').addEventListener('click', togglePause);
            document.getElementById('restart-btn').addEventListener('click', restartGame);
            document.getElementById('sound-toggle-btn').addEventListener('click', toggleSound);
            document.getElementById('main-menu-btn').addEventListener('click', goToMainMenu);
            
            // صفحه مرگ
            document.getElementById('retry-btn').addEventListener('click', restartGame);
            document.getElementById('death-menu-btn').addEventListener('click', goToMainMenu);
            
            // صفحه سطح
            document.getElementById('start-level-btn').addEventListener('click', startNextLevel);
            
            // کلیک روی Canvas برای شروع بازی
            document.getElementById('game-canvas').addEventListener('click', () => {
                if (!Game.state.running && !Game.state.paused) {
                    startGame();
                }
            });
        }
        
        function togglePause() {
            Game.state.paused = !Game.state.paused;
            
            if (Game.state.paused) {
                document.getElementById('pause-menu').style.display = 'flex';
                if (Game.state.musicEnabled) {
                    Game.sounds.music.pause();
                }
            } else {
                document.getElementById('pause-menu').style.display = 'none';
                if (Game.state.musicEnabled && Game.state.running) {
                    Game.sounds.music.play();
                }
            }
        }
        
        function toggleSound() {
            Game.state.musicEnabled = !Game.state.musicEnabled;
            Game.state.soundEnabled = !Game.state.soundEnabled;
            
            const btn = document.getElementById('sound-toggle-btn');
            if (Game.state.musicEnabled) {
                btn.innerHTML = '<i class="fas fa-volume-up"></i> صدا: روشن';
                if (Game.state.running && !Game.state.paused) {
                    Game.sounds.music.play();
                }
            } else {
                btn.innerHTML = '<i class="fas fa-volume-mute"></i> صدا: خاموش';
                Game.sounds.music.pause();
            }
        }
        
        function restartGame() {
            // پنهان کردن منوها
            document.getElementById('pause-menu').style.display = 'none';
            document.getElementById('death-screen').style.display = 'none';
            document.getElementById('level-screen').style.display = 'none';
            
            // ریست وضعیت بازی
            Game.state = {
                loaded: true,
                running: true,
                paused: false,
                playerAlive: true,
                currentLevel: 1,
                score: 0,
                enemiesKilled: 0,
                startTime: Date.now(),
                gameTime: 0,
                musicEnabled: Game.state.musicEnabled,
                soundEnabled: Game.state.soundEnabled
            };
            
            Game.enemies = [];
            Game.particles = [];
            Game.abilities = [];
            Game.levelComplete = false;
            
            // ایجاد بازیکن جدید
            Game.player = new Player(Game.config.canvasWidth / 2, Game.config.canvasHeight / 2);
            
            // به‌روزرسانی UI
            document.getElementById('level').textContent = '1';
            document.getElementById('score').textContent = '0';
            document.getElementById('enemy-count').textContent = '0';
            updateHealthBar();
            updateEnergyBar();
            
            // شروع موسیقی
            if (Game.state.musicEnabled) {
                Game.sounds.music.currentTime = 0;
                Game.sounds.music.play();
            }
            
            showNotification('بازی مجدداً شروع شد!', 2000);
        }
        
        function goToMainMenu() {
            // توقف بازی
            Game.state.running = false;
            Game.state.paused = false;
            
            // پنهان کردن منوها
            document.getElementById('pause-menu').style.display = 'none';
            document.getElementById('death-screen').style.display = 'none';
            document.getElementById('level-screen').style.display = 'none';
            
            // توقف موسیقی
            Game.sounds.music.pause();
            
            // بازگشت به صفحه اصلی
            setTimeout(() => {
                window.location.href = 'main.html';
            }, 500);
        }
        
        function startGame() {
            Game.state.running = true;
            Game.state.paused = false;
            Game.state.playerAlive = true;
            
            // ایجاد بازیکن
            Game.player = new Player(Game.config.canvasWidth / 2, Game.config.canvasHeight / 2);
            
            // ایجاد چند دشمن اولیه
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    spawnEnemy();
                }, i * 1000);
            }
            
            // شروع موسیقی
            if (Game.state.musicEnabled) {
                Game.sounds.music.currentTime = 0;
                Game.sounds.music.play();
            }
            
            showNotification('بازی شروع شد! 10 دشمن را نابود کنید.', 3000);
        }
        
        // ==================== راه‌اندازی بازی ====================
        async function initGame() {
            // تنظیم Canvas
            const canvas = document.getElementById('game-canvas');
            const container = document.getElementById('game-container');
            
            Game.config.canvasWidth = canvas.width = container.clientWidth;
            Game.config.canvasHeight = canvas.height = container.clientHeight;
            
            // تنظیم صداها
            Game.sounds = {
                music: document.getElementById('background-music'),
                attack: document.getElementById('attack-sound'),
                damage: document.getElementById('damage-sound'),
                enemyDeath: document.getElementById('enemy-death-sound'),
                ability: document.getElementById('ability-sound'),
                levelUp: document.getElementById('level-up-sound'),
                button: document.getElementById('button-sound')
            };
            
            // تنظیم کنترل‌ها
            initControls();
            
            // تنظیم رویداد تغییر سایز پنجره
            window.addEventListener('resize', () => {
                Game.config.canvasWidth = canvas.width = container.clientWidth;
                Game.config.canvasHeight = canvas.height = container.clientHeight;
            });
            
            // اتمام بارگذاری
            Game.state.loaded = true;
            
            // شروع حلقه بازی
            requestAnimationFrame(gameLoop);
            
            // نمایش صفحه شروع
            showNotification('برای شروع بازی کلیک کنید', 5000);
        }
        
        // ==================== بارگذاری بازی ====================
        document.addEventListener('DOMContentLoaded', () => {
            // بارگذاری تدریجی
            let loadProgress = 0;
            const loadingInterval = setInterval(() => {
                loadProgress += Math.random() * 15 + 5;
                if (loadProgress > 100) {
                    loadProgress = 100;
                    clearInterval(loadingInterval);
                    
                    document.getElementById('loading-text').textContent = 'آماده است!';
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('loading-screen').style.display = 'none';
                            document.getElementById('game-container').style.display = 'block';
                            initGame();
                        }, 500);
                    }, 1000);
                }
                document.getElementById('loading-progress').style.width = `${loadProgress}%`;
                document.getElementById('loading-text').textContent = `در حال بارگذاری... ${Math.floor(loadProgress)}%`;
            }, 150);
        });
    </script>
</body>
</html>
